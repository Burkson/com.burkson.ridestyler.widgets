!function(){function e(e,i){var n=this;if(e&&"string"==typeof e){if("object"!=typeof i&&(i={}),this.containerId=e,this.container=document.getElementById(e),this.name="string"==typeof i.name?i.name.trim():"",this.dimensions=null,i.hasOwnProperty("dimensions")&&"object"==typeof i.dimensions&&2===i.dimensions.length){var a=parseInt(i.dimensions[0]),r=parseInt(i.dimensions[1]);isNaN(a)||isNaN(r)||(this.dimensions=[a,r])}this.layers=[],this.layerHash={},this.layerCount=0,this.loaded=!1,this.imgLoadPromise=new t.promise,this.initPromise=new t.promise,this.imgDrawPromise=new t.promise,this.imgOperations=["multiply","screen","grayscale"],this.dfltOperation="multiply",this.dfltCanvasStyle={position:"absolute",opacity:0},this.container?n.initPromise.resolve():document.addEventListener("DOMContentLoaded",function(){n.container=document.getElementById(n.containerId),n.initPromise.resolve()})}else console.error("Invalid containerId")}e.prototype.createCanvas=function(e){var t=document.createElement("canvas");if("object"==typeof e)for(var i in e)t.style[i]=e[i];return this.container.appendChild(t),t},e.prototype.checkAsyncComplete=function(){var e=this,t=this.layers.length,i=0,n=0;if(t===this.layerCount){for(n=0;n<t;n++)this.layers[n].loaded&&i++;i===this.layerCount&&(e.loaded=!0,e.imgLoadPromise.resolve())}},e.prototype.setLayers=function(e){if("object"==typeof e&&e.length){var t=this;return this.initPromise.done(function(){var i=e.length,n="",a=[],r=t.dfltCanvasStyle;t.layers=[],t.layerCount=i;for(var s=0;s<i;s++)"object"!=typeof e[s]||"string"!=typeof e[s].name||e[s].name,e[s].img?"string"==typeof(n=e[s].img)?(a[s]=new Image,a[s].lbIdx=s,a[s].lbName=e[s].name.trim(),a[s].lbReadOnly=!!e[s].readOnly,t.layers[s]={name:a[s].lbName,loaded:!1},r.zIndex=a[s].lbIdx+1,a[s].canvas=t.createCanvas(r),a[s].ctx=a[s].canvas.getContext("2d"),a[s].onload=function(){this.canvas.setAttribute("data-layername",this.lbName),this.canvas.setAttribute("data-idx",this.lbIdx),t.layers[this.lbIdx]={name:this.lbName,img:this,idx:this.lbIdx,canvas:this.canvas,ctx:this.ctx,loaded:!0,readOnly:this.lbReadOnly},t.layerHash[this.lbName]=this.lbIdx,t.checkAsyncComplete()},a[s].src=n.trim()):console.error("Invalid image for layer "+e[s].name):console.error("Invalid layer: "+e[s].name);return t.imgLoadPromise}),t.imgLoadPromise.done(function(){t.drawImages()}),t.imgDrawPromise}},e.prototype.drawImages=function(){var e=this.layers.length,i=0,n=0,a=0,r=0,s=0,o=0,l=1,h=null,c=0;if(this.dimensions){for(c=0;c<e;c++)this.layers[c].img.width>a&&(a=this.layers[c].img.width),this.layers[c].img.height>r&&(r=this.layers[c].img.height);(l=(s=parseFloat(this.dimensions[0]/a))<(o=parseFloat(this.dimensions[1]/r))?s:o)>1&&(l=1)}for(c=0;c<e;c++)h=this.layers[c],i=Math.floor(h.img.width*l),n=Math.floor(h.img.height*l),h.canvas.width=i,h.canvas.height=n,h.img.origW=h.img.width,h.img.origH=h.img.height,h.img.width=i,h.img.height=n,h.ctx.drawImage(h.img,0,0,i,n),t.show(h.canvas,"block",!0),h.imgData=h.ctx.getImageData(0,0,i,n),h.masterCvs=h.canvas.cloneNode(!1),h.masterCvs.getContext("2d").drawImage(h.img,0,0,i,n),h.unscaledCvs=document.createElement("canvas"),h.unscaledCvs.width=h.img.origW,h.unscaledCvs.height=h.img.origH,h.unscaledCvs.getContext("2d").drawImage(h.img,0,0,h.img.origW,h.img.origH);this.imgDrawPromise.resolve()},e.prototype.setColor=function(e,t,i){if(e&&t&&this.layers.length){var n=this.getLayer(e);n.ctx;if(n){if(i){if("string"!=typeof i||-1===this.imgOperations.indexOf(i.toLowerCase()))return void console.error("Invalid operation");i=i.toLowerCase()}else i=this.dfltOperation;n.currentColor=t,this.colorLayer(n,t,i)}else console.error("Invalid layer: "+e)}else console.error("Unable to set colors. Invalid params or no layers present")},e.prototype.colorLayer=function(e,i,n){var a=e.masterCvs,r=a.getContext("2d"),s=r.getImageData(0,0,a.width,a.height),o=s.data,l=r.getImageData(0,0,a.width,a.height).data,h=t.hexToRgb(i),c={},g=null,d=null,m=null,u=0;n=n||this.dfltOperation;for(var y=0;y<o.length;y+=4)switch(c.r=l[y+0],c.g=l[y+1],c.b=l[y+2],c.a=l[y+3],n){case"multiply":o[y+0]=c.r/255*(h.r/255)*255,o[y+1]=c.g/255*(h.g/255)*255,o[y+2]=c.b/255*(h.b/255)*255,o[y+3]=c.a;break;case"screen":g=t.rgbToHsl(c.r,c.g,c.b),d=t.rgbToHsl(h.r,h.g,h.b),m=t.hslToRgb(d.h,d.s,g.l),o[y+0]=m.r,o[y+1]=m.g,o[y+2]=m.b,o[y+3]=c.a;break;case"grayscale":u=(o[y]+o[y+1]+o[y+2])/3,o[y]=u,o[y+1]=u,o[y+2]=u}e.ctx.putImageData(s,0,0)},e.prototype.resetLayer=function(e,t,i){var n=this.getLayer(e);n&&(t=isNaN(parseInt(t))?n.img.width:parseInt(t),i=isNaN(parseInt(i))?n.img.height:parseInt(i),n.ctx.clearRect(0,0,n.canvas.width,n.canvas.height),n.ctx.drawImage(n.img,0,0,t,i),n.currentColor="")},e.prototype.resetAllLayers=function(){for(var e=this.layers.length,t=0;t<e;t++)this.resetLayer(this.layers[t].name)},e.prototype.getOperations=function(){return this.imgOperations},e.prototype.getLayer=function(e){if("string"==typeof e&&e.trim()&&this.layers.length)return void 0!==this.layerHash[e]?this.layers[this.layerHash[e]]:null;console.error("Invalid layer name or no layers set")},e.prototype.getImage=function(e){var t="",i=this.layers.length,n=null,a=null,r=null,s=null,o={display:"none"};{if(this.layers.length){e="string"==typeof e?e.trim():"image/png",s=this.getDimensions(),(n=this.createCanvas(o)).width=s.width,n.height=s.height,a=n.getContext("2d");for(var l=0;l<i;l++)r=this.layers[l],a.drawImage(r.canvas,0,0,r.img.width,r.img.height);return t=n.toDataURL(e),this.container.removeChild(n),t}console.error("Unable to save image: no layers present")}},e.prototype.getUnscaledImage=function(e){var t=this.layers.length,i=null,n=null,a=null,r=null,s=null,o=null,l=null,h={display:"none"};{if(this.layers.length){o=this.getOrigDimensions(),(i=this.createCanvas(h)).width=o.width,i.height=o.height;for(var c=0;c<t;c++)a=this.layers[c],(s=this.createCanvas(h)).width=a.img.origW,s.height=a.img.origH,(n=s.getContext("2d")).drawImage(a.unscaledCvs,0,0),a.currentColor&&(r={masterCvs:s,ctx:n,currentColor:a.currentColor},this.colorLayer(r,a.currentColor)),i.getContext("2d").drawImage(s,0,0),this.container.removeChild(s);return l=i.msToBlob?i.msToBlob():i.toDataURL(e),this.container.removeChild(i),l}console.error("Unable to save image: no layers present")}},e.prototype.getDimensions=function(){for(var e={width:0,height:0},t=null,i=0,n=this.layers.length;i<n;i++)(t=this.layers[i]).canvas.width>e.width&&(e.width=t.canvas.width),t.canvas.height>e.height&&(e.height=t.canvas.height);return e},e.prototype.getOrigDimensions=function(){for(var e={width:0,height:0},t=null,i=0,n=this.layers.length;i<n;i++)(t=this.layers[i]).img.origW>e.width&&(e.width=t.img.origW),t.img.origH>e.height&&(e.height=t.img.origH);return e};var t={};t.hexToRgb=function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,i=null;return e=e.replace(t,function(e,t,i,n){return t+t+i+i+n+n}),(i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e))?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},t.rgbToHsl=function(e,t,i){e/=255,t/=255,i/=255;var n,a,r=Math.max(e,t,i),s=Math.min(e,t,i),o=(r+s)/2;if(r==s)n=a=0;else{var l=r-s;switch(a=o>.5?l/(2-r-s):l/(r+s),r){case e:n=(t-i)/l+(t<i?6:0);break;case t:n=(i-e)/l+2;break;case i:n=(e-t)/l+4}n/=6}return{h:n,s:a,l:o}},t.hslToRgb=function(e,t,i){var n,a,r;if(0==t)n=a=r=i;else{var s=i<.5?i*(1+t):i+t-i*t,o=2*i-s;n=hue2rgb(o,s,e+1/3),a=hue2rgb(o,s,e),r=hue2rgb(o,s,e-1/3)}return{r:Math.round(255*n),g:Math.round(255*a),b:Math.round(255*r)}},t.hue2rgb=function(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e},t.promise=function(){function e(e){r.push(e),t()}function t(){if(n!==i.pending)for(;r.length>0;){var e=r.shift();n===i.resolved&&"function"==typeof e.done?e.done(a):n===i.rejected&&"function"==typeof e.fail&&e.fail(a),"function"==typeof e.always&&e.always(a)}}var i={pending:0,resolved:1,rejected:2},n=i.pending,a=null,r=[];return{state:function(){return n},value:function(){return a},changeState:function(e,r){return n===e?console.error("Cannot changeState to same state: "+e):n!==i.pending?console.error("Cannot changeState when promise is finalized."):(n=e,a=r,t(),n)},resolve:function(e){this.changeState(i.resolved,e)},reject:function(e){this.changeState(i.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return n===i.resolved},isRejected:function(){return n===i.rejected}}},t.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},t.nonAlpha2Dash=function(e){return e.replace(/\W+/g,"-")},t.toggle=function(e,t){t&&(t.style.display="none",t.style.opacity=0),e&&(e.style.display="block",e.clientWidth,e.style.opacity=1)},t.hasClass=function(e,t){var i=new RegExp("(?:\\s|^)"+t+"(?:\\s|$)");return!!e.className.match(i)},t.addClass=function(e,t){-1===e.className.indexOf(t)&&(e.className+=" "+t,e.className=e.className.trim())},t.removeClass=function(e,t){var i=null,n=0;"object"!=typeof t&&(t=[t]),n=t.length;for(var a=0;a<n;a++)i=new RegExp("(?:\\s|^)"+t[a]+"(?:\\s|$)"),e.className=e.className.replace(i," ")},t.hide=function(e,t){e&&"object"==typeof e&&(t&&(e.style.opacity=0),e.style.display="none")},t.show=function(e,t,i,n){e&&"object"==typeof e&&(e.style.display=t||"block",i&&(e.style.opacity=n||1))},window.LBUtil=t,window.LayerBuilder=e}();