!function(){function e(e,l,a){var r=this;if(e&&"string"==typeof e)if(l&&"object"!=typeof l)console.error("Invalid layer stacks");else if(LayerBuilder&&"function"==typeof LayerBuilder){if("object"!=typeof a&&(a={}),a.hasOwnProperty("defaultLayerOpts")&&a.defaultLayerOpts.length?this.defaultLayerOpts=a.defaultLayerOpts:this.defaultLayerOpts=null,this.dfltWheelDims=[300,300],a.hasOwnProperty("wheelDims")&&"object"==typeof a.wheelDims&&2===a.wheelDims.length){var n=parseInt(a.wheelDims[0]),s=parseInt(a.wheelDims[1]);isNaN(n)||isNaN(s)?this.wheelDims=this.dfltWheelDims:this.wheelDims=[n,s]}else this.wheelDims=this.dfltWheelDims;this.containerId=e,this.container=document.getElementById(e),this.smallWidth=880,this.smallestWidth=480,this.dirtyStacks=l,this.layerStacks=[],this.stackLookup={},this.visibleStacks=0,this.initPromise=new t,this.asyncPromise=new t,this.loadedPromise=new t,this.tplLoaded=!1,this.cssLoaded=!1,this.tplUrl="src/html/template.html",this.cssUrl="src/css/wheelBuilder.css",this.tplHtml="",this.wrapEl=null,this.ctrlEl=null,this.selectorEl=null,this.layerSelectWrap=null,this.layerOptsWrap=null,this.selectedStack=null,this.dfltColorOp="multiply",this.container?(r.initPromise.resolve(),r.onDomReady()):document.addEventListener("DOMContentLoaded",function(){r.container=document.getElementById(r.containerId),r.initPromise.resolve(),r.onDomReady()})}else console.error("LayerBuilder not found");else console.error("Invalid container ID")}function t(){function e(e){n.push(e),t()}function t(){if(a!==l.pending)for(;n.length>0;){var e=n.shift();a===l.resolved&&"function"==typeof e.done?e.done(r):a===l.rejected&&"function"==typeof e.fail&&e.fail(r),"function"==typeof e.always&&e.always(r)}}var l={pending:0,resolved:1,rejected:2},a=l.pending,r=null,n=[];return{state:function(){return a},value:function(){return r},changeState:function(e,n){return a===e?console.error("Cannot changeState to same state: "+e):a!==l.pending?console.error("Cannot changeState when promise is finalized."):(a=e,r=n,t(),a)},resolve:function(e){this.changeState(l.resolved,e)},reject:function(e){this.changeState(l.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return a===l.resolved},isRejected:function(){return a===l.rejected}}}e.prototype.checkLoaded=function(){for(var e=this.layerStacks.length,t=0,l=0;l<e;l++)this.layerStacks[l].lb.loaded&&t++;t===e&&this.loadedPromise.resolve()},e.prototype.loaded=function(e){this.loadedPromise.done(function(){e.call()})},e.prototype.onDomReady=function(){var e=this.onAsyncComplete;null!=this.container?(this.loadStyles(e),this.loadTemplate(e)):console.error("Invalid container Id")},e.prototype.onAsyncComplete=function(){this.tplLoaded&&this.cssLoaded&&(this.initApp(),this.asyncPromise.resolve())},e.prototype.initApp=function(){var e=this,t=this.dirtyStacks.length;if(this.tplLoaded&&this.cssLoaded){this.container.innerHTML=this.tplHtml,this.wrapEl=document.getElementById("wb-wrapper"),this.ctrlEl=this.wrapEl.getElementsByClassName("wb-ctrl-wrap")[0],this.layerSelectWrap=this.ctrlEl.getElementsByClassName("wb-layer-select")[0],this.layerOptsWrap=this.ctrlEl.getElementsByClassName("wb-layer-options")[0],this.selectorEl=this.wrapEl.getElementsByClassName("wb-wheel-selector")[0],window.addEventListener("resize",function(){e.adjustLayout()}),this.ctrlEl.getElementsByClassName("wb-download")[0].onclick=function(t){e.onDownloadClick(t)};for(var l=0;l<t;l++)this.addLayerStack(this.dirtyStacks[l]);this.adjustLayout()}else console.error("Template not loaded, unable to initialize app")},e.prototype.adjustLayout=function(){if(this.container){var e=this.container.offsetWidth;this.wrapEl&&(e<=this.smallestWidth?(r(this.wrapEl,"wb-small")||n(this.wrapEl,"wb-small"),r(this.wrapEl,"wb-smallest")||n(this.wrapEl,"wb-smallest")):e<=this.smallWidth?(r(this.wrapEl,"wb-small")||n(this.wrapEl,"wb-small"),s(this.wrapEl,"wb-smallest")):s(this.wrapEl,["wb-small","wb-smallest"]))}},e.prototype.selectStack=function(e){var t=this.layerStacks[this.selectedStack],l=this.getLayerStack(e);t&&t.layerSelectEl&&a(null,t.layerSelectEl),this.selectedStack=this.stackLookup[e],this.showPreviewStack(l),this.setStackTitle(l.name),l.layerSelectEl?a(l.layerSelectEl):this.createLayerSelector(l,!0),a(this.layerSelectWrap,this.layerOptsWrap)},e.prototype.createLayerSelector=function(e){var t=this,r=e.layers.length,s="",o=null,i=null,c=null,d=null,p=null,h=null,y=document.createElement("ul");n(y,"wb-layer-selector");for(var m=0;m<r;m++)(o=e.layers[m]).readOnly||(s=l(o.name),d=document.createElement("a"),p=document.createElement("li"),i=document.createElement("span"),c=document.createElement("span"),n(p,"wb-ctrl-layer"),n(p,"wb-ctrl-layer-"+s),n(i,"wb-color"),o.currentColor&&(i.style.backgroundColor=o.currentColor),c.innerText=o.name,d.appendChild(i),d.appendChild(c),d.setAttribute("data-layeridx",m),d.onclick=function(l){var r=l.target,n=null;"A"!==r.tagName&&(r=r.parentElement),n=parseInt(r.getAttribute("data-layeridx")),t.createLayerOpts(e,n),a(t.layerOptsWrap,t.layerSelectWrap)},p.appendChild(d),y.appendChild(p));p=document.createElement("li"),(h=document.createElement("button")).innerText="Reset All",h.onclick=function(){t.resetAllLayers()},n(h,"wb-reset-all"),p.appendChild(h),y.appendChild(p),e.layerSelectEl=y,this.layerSelectWrap.appendChild(y)},e.prototype.showPreviewStack=function(e){var t=this.wrapEl.getElementsByClassName("wb-wheel-selected");t.length>0&&(t[0].style.display="none",s(t[0],"wb-wheel-selected")),n(e.containEl,"wb-wheel-selected"),e.containEl.style.display="block",e.containEl.style.opacity=1},e.prototype.createLayerOpts=function(e,t){var r=this,s=e.layers[t],o=(l(s.name),s.options),i=null,c=null,d=null,p=null,h=null,y=null,m=null,u="";if("object"==typeof o&&o.length){this.layerOptsWrap.innerHTML="",i=document.createElement("ul"),c=document.createElement("button"),d=document.createElement("button");for(var f=0,w=o.length;f<w;f++)"string"==typeof o[f].name&&o[f].name.trim()?"string"==typeof o[f].color&&o[f].color.trim()?(u="string"!=typeof o[f].operation||-1===e.lb.getOperations().indexOf(o[f].operation.toLowerCase())?this.dfltColorOp:o[f].operation.trim().toLowerCase(),p=document.createElement("li"),y=document.createElement("span"),m=document.createElement("span"),h=document.createElement("a"),n(y,"wb-color"),y.style.backgroundColor=o[f].color.trim(),h.appendChild(y),m.innerHTML=o[f].name.trim(),h.appendChild(m),h.onclick=function(e){var t=e.target,l="",a="";"A"!==t.tagName&&(t=t.parentElement),l=t.getAttribute("data-color"),a=t.getAttribute("data-operation"),r.setLayerColor(s.name,l,a)},h.setAttribute("data-color",o[f].color.trim()),h.setAttribute("data-operation",u),p.appendChild(h),i.appendChild(p)):console.error("Invalid color provided for layer "+s.name+" option "+o.name):console.error("Invalid name provided for layer "+s.name+" option");this.layerOptsWrap.appendChild(i),c.innerText="Back",c.onclick=function(){a(r.layerSelectWrap,r.layerOptsWrap)},d.innerText="Reset",d.onclick=function(){r.resetLayer(s.name)},this.layerOptsWrap.appendChild(c),this.layerOptsWrap.appendChild(d),a(this.layerOptsWrap,this.layerSelectWrap)}},e.prototype.addLayerStack=function(e){var t=this;e&&"object"==typeof e?this.asyncPromise.done(function(){var r=t.getLayerStack(e.name),s=t.wrapEl.getElementsByClassName("wb-wheel-preview")[0],o=null,i=null,c="";if(e.name&&e.name.trim())if(e.name=e.name.trim(),c=l(e.name.toLowerCase()),e.visible=!!e.visible,e.selected=!!e.selected,"object"==typeof e.layers&&e.layers.length){for(var d=0,p=e.layers.length;d<p;d++)e.layers[d]=t.validateLayer(e.layers[d]);r?((o=t.wrapEl.getElementById("wb-wheel-"+c)).innerHTML="",idx=t.stackLookup[e.name],t.layerStacks[idx]=e):((o=document.createElement("div")).id="wb-wheel-"+c,s.appendChild(o),idx=t.layerStacks.length,t.stackLookup[e.name]=idx,t.layerStacks[idx]=e),n(o,"wb-wheel"),(i=new LayerBuilder(o.id,{dimensions:t.wheelDims})).setLayers(e.layers).done(function(){dims=i.getDimensions(),o.style.width=dims.width+"px",o.style.height=dims.height+"px",e.visible&&t.addStackSelector(e),e.selected||a(null,o)}),i.imgLoadPromise.done(function(){t.checkLoaded()}),t.layerStacks[idx].lb=i,t.layerStacks[idx].containEl=o,t.layerStacks[idx].idx=idx,e.visible&&(t.visibleStacks++,e.selected&&(n(o,"wb-wheel-selected"),t.selectedStack=idx,t.selectStack(e.name)))}else console.error("No layers provided");else console.error("No name provided for layer stack")}):console.error("Invalid layer stack")},e.prototype.addStackSelector=function(e){var t=this,l=e.lb.getImage(),a=new Image,r=document.createElement("li");if(a.src=l,r.appendChild(a),r.onclick=function(l){var a=l.target,r=a,o=t.selectorEl.getElementsByClassName("wb-stack-selected")[0];"li"!==a.tagName.toLowerCase&&(r=a.parentElement),s(o,"wb-stack-selected"),t.selectStack(e.name),n(r,"wb-stack-selected")},e.selected&&n(r,"wb-stack-selected"),this.selectorEl.children.length){var o=this.selectorEl.children[e.idx];o?this.selectorEl.insertBefore(r,o):e.idx>=this.selectorEl.children.length?this.selectorEl.appendChild(r):this.selectorEl.insertBefore(r,this.selectorEl.firstChild)}else this.selectorEl.appendChild(r);this.visibleStacks>1?this.selectorEl.style.opacity=1:this.selectorEl.style.opacity=0},e.prototype.setLayerColor=function(e,t,a){var r=this.layerStacks.length,n=null,s=null,o=null,i=l(e),c=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+i);if("string"==typeof e&&e.trim()){for(var d=0;d<r;d++)if(s=this.layerStacks[d],(o=s.lb.getLayer(e))&&!o.readOnly){s.lb.setColor(e,t,a),n=s.layers.length;for(var p=0;p<n;p++)s.layers[p].name===e&&(s.layers[p].currentColor=t)}for(r=c.length,d=0;d<r;d++)c[d].getElementsByTagName("span")[0].style.backgroundColor=t}else console.error("Invalid layer name")},e.prototype.resetLayer=function(e){for(var t=this.layerStacks.length,a=null,r=null,n=l(e),s=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+n),o=0;o<t;o++){(r=this.layerStacks[o]).lb.resetLayer(e),a=r.layers.length;for(var i=0;i<a;i++)r.layers[i].name===e&&(r.layers[i].currentColor="")}for(t=s.length,o=0;o<t;o++)s[o].getElementsByTagName("span")[0].style.backgroundColor=""},e.prototype.resetAllLayers=function(){for(var e=this.layerStacks.length,t=null,l=null,a=this.ctrlEl.getElementsByClassName("wb-color"),r=0;r<e;r++){(l=this.layerStacks[r]).lb.resetAllLayers(),t=l.layers.length;for(var n=0;n<t;n++)l.layers[n].currentColor=""}for(e=a.length,r=0;r<e;r++)a[r].style.backgroundColor=""},e.prototype.validateLayer=function(e){return"object"!=typeof e?(console.error("Invalid layer for stack "+ls.name),!1):"string"!=typeof e.name||"string"!=typeof e.img?(console.error("Layer name and img properties invalid"),!1):(e.name=e.name.trim(),e.img=e.img.trim(),e.label="string"==typeof e.label&&e.label.trim()?e.label:e.name,e.readOnly=!!e.readOnly,e.options&&"object"==typeof e.options&&e.options.length||(self.defaultLayerOpts.length?e.options=self.defaultLayerOpts:(e.readOnly=!0,e.options=[])),e)},e.prototype.getLayerStack=function(e){return this.stackLookup.hasOwnProperty(e)?this.layerStacks[this.stackLookup[e]]:null},e.prototype.setStackTitle=function(e){"string"==typeof e&&(this.ctrlEl.getElementsByClassName("wb-ctrl-title")[0].innerHTML=e)},e.prototype.loadTemplate=function(e){var t=this,l=new XMLHttpRequest;l.onreadystatechange=function(){4===l.readyState&&(200===l.status?(t.tplHtml=l.responseText,t.tplLoaded=!0,"function"==typeof e&&e.apply(t)):console.error("xhr request for template failed"))},l.open("GET",this.tplUrl,!0),l.send(null)},e.prototype.loadStyles=function(e){var t=this,l=document.createElement("link"),a=document.getElementsByTagName("head")[0];l.rel="stylesheet",l.type="text/css",l.href=this.cssUrl,l.onload=function(){t.cssLoaded||(t.cssLoaded=!0,"function"==typeof e&&e.apply(t))},a.insertBefore(l,a.firstElementChild)},e.prototype.getStackImage=function(e){var t=this.getLayerStack(e),l=null;return t&&t.lb&&(l=t.lb.getUnscaledImage()),l},e.prototype.onDownloadClick=function(e){var t=e.target,a=this.layerStacks[this.selectedStack],r=l(a.name)+".png",n="";a&&a.lb?(n=this.getStackImage(a.name),window.navigator.msSaveBlob?window.navigator.msSaveBlob(n,r):(t.href=n,t.download=r)):console.error("Cannot export: no stack selected")};var l=function(e){return e.replace(/\W+/g,"-")},a=function(e,t){e&&(e.style.display="block",e.style.opacity=1),t&&(t.style.display="none",t.style.opacity=0)},r=function(e,t){var l=new RegExp("(?:\\s|^)"+t+"(?:\\s|$)");return!!e.className.match(l)},n=function(e,t){-1===e.className.indexOf(t)&&(e.className+=" "+t,e.className=e.className.trim())},s=function(e,t){var l=null,a=0;"object"!=typeof t&&(t=[t]),a=t.length;for(var r=0;r<a;r++)l=new RegExp("(?:\\s|^)"+t[r]+"(?:\\s|$)"),e.className=e.className.replace(l," ")};window.WheelBuilder=e}();