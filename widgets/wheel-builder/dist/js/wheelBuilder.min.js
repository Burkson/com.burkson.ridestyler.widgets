!function(){function e(e,l,r){var n=this;if(e&&"string"==typeof e)if(l&&"object"!=typeof l)console.error("Invalid layer stacks");else if(LayerBuilder&&"function"==typeof LayerBuilder){if("object"!=typeof r&&(r={}),r.hasOwnProperty("defaultLayerOpts")&&r.defaultLayerOpts.length?this.defaultLayerOpts=r.defaultLayerOpts:this.defaultLayerOpts=null,this.dev=!!r.hasOwnProperty("dev")&&!!r.dev,this.containerId=e,this.container=document.getElementById(e),this.smallWidth=900,this.smallestWidth=500,this.dirtyStacks=l,this.layerStacks=[],this.stackLookup={},this.visibleStacks=0,this.initPromise=new t,this.asyncPromise=new t,this.loadedPromise=new t,this.tplLoaded=!1,this.cssLoaded=!1,this.extJsLoaded=!1,this.cdnUrl="https://rawgit.com/Burkson/com.burkson.ridestyler.widgets/master/widgets/wheel-builder/dist/",this.urlPfx=this.dev?"src/":this.cdnUrl,this.tplUrl=this.urlPfx+"html/template.html",r.hasOwnProperty("cssUrl")?this.cssUrl=!(!r.cssUrl||"string"!=typeof r.cssUrl)&&r.cssUrl:this.cssUrl=this.dev?this.urlPfx+"css/wheelBuilder.css":this.urlPfx+"css/wheelBuilder.min.css",window.jscolor||(this.jsColorUrl=this.urlPfx+"js/jscolor.min.js"),this.tplHtml="",this.wrapEl=null,this.ctrlWrap=null,this.selectorEl=null,this.layerSelectWrap=null,this.layerOptsWrap=null,this.topBar=null,this.ctrlHeader=null,this.ctrlTitle=null,this.ctrl=null,this.backBtn=null,this.selectedStack=null,this.dfltColorOp="multiply",this.dfltPickerColor="FFFFFF",this.dfltCtrlTitle="Customize",this.dfltWheelDims=[500,500],r.hasOwnProperty("wheelDims")&&"object"==typeof r.wheelDims&&2===r.wheelDims.length){var s=parseInt(r.wheelDims[0]),a=parseInt(r.wheelDims[1]);isNaN(s)||isNaN(a)?this.wheelDims=this.dfltWheelDims:this.wheelDims=[s,a]}else this.wheelDims=this.dfltWheelDims;this.cancelText=r.cancelText?r.cancelText:"Cancel",this.confirmText=r.confirmText?r.confirmText:"Confirm",this.onCancel="function"==typeof r.onCancel?r.onCancel:null,this.onConfirm="function"==typeof r.onConfirm?r.onConfirm:null,this.container?(n.initPromise.resolve(),n.onDomReady()):document.addEventListener("DOMContentLoaded",function(){n.container=document.getElementById(n.containerId),n.container?(n.initPromise.resolve(),n.onDomReady()):console.error("Container does not exist")})}else console.error("LayerBuilder not found");else console.error("Invalid container ID")}function t(){function e(e){s.push(e),t()}function t(){if(r!==l.pending)for(;s.length>0;){var e=s.shift();r===l.resolved&&"function"==typeof e.done?e.done(n):r===l.rejected&&"function"==typeof e.fail&&e.fail(n),"function"==typeof e.always&&e.always(n)}}var l={pending:0,resolved:1,rejected:2},r=l.pending,n=null,s=[];return{state:function(){return r},value:function(){return n},changeState:function(e,s){return r===e?console.error("Cannot changeState to same state: "+e):r!==l.pending?console.error("Cannot changeState when promise is finalized."):(r=e,n=s,t(),r)},resolve:function(e){this.changeState(l.resolved,e)},reject:function(e){this.changeState(l.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return r===l.resolved},isRejected:function(){return r===l.rejected}}}e.prototype.checkLoaded=function(){for(var e=this.layerStacks.length,t=0,l=0;l<e;l++)this.layerStacks[l].lb.loaded&&t++;t===e&&this.loadedPromise.resolve()},e.prototype.loaded=function(e){this.loadedPromise.done(function(){e.call()})},e.prototype.onDomReady=function(){var e=this.onAsyncComplete;null!=this.container?(this.loadExternalJs(e),this.loadStyles(e),this.loadTemplate(e)):console.error("Invalid container Id")},e.prototype.isAsyncComplete=function(){return this.tplLoaded&&this.cssLoaded&&this.extJsLoaded},e.prototype.onAsyncComplete=function(){this.isAsyncComplete()&&(this.initApp(),this.asyncPromise.resolve())},e.prototype.initApp=function(){var e=this,t=this.dirtyStacks.length;if(this.isAsyncComplete()){this.container.innerHTML=this.tplHtml,this.wrapEl=document.getElementById("wb-wrapper"),this.ctrlWrap=this.wrapEl.getElementsByClassName("wb-ctrl-wrap")[0],this.layerSelectWrap=this.ctrlWrap.getElementsByClassName("wb-layer-select")[0],this.layerOptsWrap=this.ctrlWrap.getElementsByClassName("wb-layer-options")[0],this.selectorEl=this.wrapEl.getElementsByClassName("wb-wheel-selector")[0],this.topBar=this.wrapEl.getElementsByClassName("wb-top-bar")[0],this.logo=this.topBar.getElementsByClassName("wb-logo")[0],this.ctrlHeader=this.ctrlWrap.getElementsByClassName("wb-ctrl-header")[0],this.ctrlTitle=this.ctrlWrap.getElementsByClassName("wb-ctrl-title")[0],this.ctrl=this.ctrlWrap.getElementsByClassName("wb-ctrl")[0],this.backBtn=this.ctrlHeader.getElementsByClassName("wb-back-btn")[0],this.initTop(),window.addEventListener("resize",function(){e.adjustLayout()});for(var l=0;l<t;l++)this.addLayerStack(this.dirtyStacks[l]);this.loadedPromise.done(function(){e.renderCtrl(),e.renderStackSelector(),e.renderPreview()}),this.adjustLayout()}else console.error("Template not loaded, unable to initialize app")},e.prototype.initTop=function(){var e=this,t=this.topBar.getElementsByClassName("wb-top-button-left")[0],l=this.topBar.getElementsByClassName("wb-top-button-right")[0],r=this.wrapEl.getElementsByClassName("wb-download")[0];this.onCancel?(t.innerText=this.cancelText,t.onclick=function(){e.onCancel.call()}):o(t),this.onConfirm?(l.innerText=this.confirmText,l.onclick=function(){e.onConfirm.call()}):o(l),r.onclick=function(t){e.onDownloadClick(t)},this.backBtn.onclick=function(){e.onBackClick()},i(this.topBar,"table",!0)},e.prototype.adjustLayout=function(){if(this.container){var e=this.container.offsetWidth;this.wrapEl&&(e<=this.smallestWidth?(n(this.wrapEl,"wb-small")||s(this.wrapEl,"wb-small"),n(this.wrapEl,"wb-smallest")||s(this.wrapEl,"wb-smallest")):e<=this.smallWidth?(n(this.wrapEl,"wb-small")||s(this.wrapEl,"wb-small"),a(this.wrapEl,"wb-smallest")):a(this.wrapEl,["wb-small","wb-smallest"]))}},e.prototype.selectStack=function(e){this.layerStacks[this.selectedStack];var t=this.getLayerStack(e);t.layerSelectEl||this.createLayerSelector(t,!0),this.colorInvalidLayers(t),this.togglePreviewStack(t),this.selectedStack=this.stackLookup[e]},e.prototype.createLayerSelector=function(e){var t=this,n=e.layers.length,a="",o=null,i=null,c=null,h=null,d=null,p=document.createElement("ul");s(p,"wb-layer-selector");for(var y=0;y<n;y++)(o=e.layers[y]).readOnly||(a=l(o.name),h=document.createElement("a"),d=document.createElement("li"),i=document.createElement("span"),c=document.createElement("span"),s(d,"wb-ctrl-layer"),s(d,"wb-ctrl-layer-"+a),s(i,"wb-color"),o.currentColor&&(i.style.backgroundColor=o.currentColor),c.innerText=o.name+" +",h.appendChild(i),h.appendChild(c),h.setAttribute("data-layeridx",y),h.onclick=function(l){var n=l.target,s=null;"A"!==n.tagName&&(n=n.parentElement),s=parseInt(n.getAttribute("data-layeridx")),t.showLayerOpts(e,s),r(t.layerOptsWrap,t.layerSelectWrap)},d.appendChild(h),p.appendChild(d));d=document.createElement("li"),e.layerSelectEl=p,this.layerSelectWrap.appendChild(p)},e.prototype.showLayerOpts=function(e,t){var n=this,a=e.layers[t],o=(l(a.name),a.options),c=null,h=null,d=null,p=null,y=null,m=null,u=null,f=null,w=null,g=null,b="";if("object"==typeof o&&o.length){this.setCtrlTitle("Options"),this.layerOptsWrap.innerHTML="",c=document.createElement("ul"),p=document.createElement("li"),h=document.createElement("button"),p.innerText=a.name+" -",i(p),c.appendChild(p);for(var C=0,k=o.length;C<k;C++)"string"==typeof o[C].name&&o[C].name.trim()?"string"==typeof o[C].color&&o[C].color.trim()?(b="string"!=typeof o[C].operation||-1===e.lb.getOperations().indexOf(o[C].operation.toLowerCase())?this.dfltColorOp:o[C].operation.trim().toLowerCase(),y=document.createElement("li"),u=document.createElement("span"),m=document.createElement("a"),s(u,"wb-color"),u.style.backgroundColor=o[C].color.trim(),m.appendChild(u),m.onclick=function(e){var t=e.target,l="",r="";"A"!==t.tagName&&(t=t.parentElement),l=t.getAttribute("data-color"),r=t.getAttribute("data-operation"),w.fromString(l),n.setLayerColor(a.name,l,r)},m.setAttribute("data-color",o[C].color.trim()),m.setAttribute("data-operation",b),m.setAttribute("title",o[C].name),y.appendChild(m),c.appendChild(y)):console.error("Invalid color provided for layer "+a.name+" option "+o.name):console.error("Invalid name provided for layer "+a.name+" option");this.layerOptsWrap.appendChild(c),f=document.createElement("input"),s(f,"jscolor"),u=document.createElement("span"),s(u,"wb-color"),y=document.createElement("li"),s(y,"wb-custom-color"),g=document.createElement("a"),s(g,"wb-js-color"),g.innerHTML="<span> Custom Color</span>",g.setAttribute("title","Custom Color"),g.onclick=function(){w.show()},(w=new jscolor(f,{hash:!0,closable:!0})).fromString(a.currentColor?a.currentColor:this.dfltPickerColor),w.onFineChange=function(){var e=this.toHEXString();n.setLayerColor(a.name,e),u.style.backgroundColor=e},g.appendChild(f),g.insertBefore(u,g.firstElementChild),y.appendChild(g),c.appendChild(y),d=document.createElement("div"),s(d,"wb-button-wrap"),h.innerText="Reset",h.onclick=function(){w.fromString(n.dfltPickerColor),u.style.backgroundColor="#"+n.dfltPickerColor,n.resetLayer(a.name)},d.appendChild(h),this.layerOptsWrap.appendChild(d),i(this.backBtn,"inline"),r(this.layerOptsWrap,this.layerSelectWrap)}},e.prototype.addLayerStack=function(e){var t=this;e&&"object"==typeof e?this.asyncPromise.done(function(){var r=t.getLayerStack(e.name),n=t.wrapEl.getElementsByClassName("wb-wheel-preview-inner")[0],a=null,i=null,c=null,h=null,d="";if(e.name&&e.name.trim())if(e.name=e.name.trim(),d=l(e.name.toLowerCase()),e.visible=!!e.visible,e.selected=!!e.selected,"object"==typeof e.layers&&e.layers.length){for(var p=0,y=e.layers.length;p<y;p++)e.layers[p]=t.validateLayer(e.layers[p]),e.layers[p]||e.layers.splice(p,1);r?((a=t.wrapEl.getElementById("wb-wheel-"+d)).innerHTML="",c=t.stackLookup[e.name],t.layerStacks[c]=e):((a=document.createElement("div")).id="wb-wheel-"+d,n.appendChild(a),c=t.layerStacks.length,t.stackLookup[e.name]=c,t.layerStacks[c]=e),s(a,"wb-wheel"),(i=new LayerBuilder(a.id,{dimensions:t.wheelDims})).setLayers(e.layers).done(function(){h=i.getDimensions(),a.style.width=h.width+"px",a.style.height=h.height+"px",e.visible&&t.addStackSelector(e),e.selected||o(a)}),i.imgLoadPromise.done(function(){t.checkLoaded()}),t.layerStacks[c].lb=i,t.layerStacks[c].containEl=a,t.layerStacks[c].idx=c,e.visible&&(t.visibleStacks++,e.selected&&(s(a,"wb-wheel-selected"),t.selectedStack=c,t.selectStack(e.name)))}else console.error("No layers provided");else console.error("No name provided for layer stack")}):console.error("Invalid layer stack")},e.prototype.addStackSelector=function(e){var t=this,l=e.lb.getImage(),r=new Image,n=document.createElement("li"),o=null;r.src=l,n.appendChild(r),n.onclick=function(l){var r=l.target,n=r,o=t.selectorEl.getElementsByClassName("wb-stack-selected")[0];"li"!==r.tagName.toLowerCase()&&(n=r.parentElement),a(o,"wb-stack-selected"),t.selectStack(e.name),s(n,"wb-stack-selected")},e.selected&&s(n,"wb-stack-selected"),this.selectorEl.children.length?(o=this.selectorEl.children[e.idx])?this.selectorEl.insertBefore(n,o):e.idx>=this.selectorEl.children.length?this.selectorEl.appendChild(n):this.selectorEl.insertBefore(n,this.selectorEl.firstChild):this.selectorEl.appendChild(n)},e.prototype.setLayerColor=function(e,t,r){var n=this.layerStacks.length,s=null,a=null,o=null,i=this.layerStacks[this.selectedStack],c=l(e),h=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+c);if("string"==typeof e&&e.trim())if(t=t.toUpperCase(),(o=i.lb.getLayer(e))&&!o.readOnly){i.lb.setColor(e,t,r);for(var d=0;d<n;d++){s=(a=this.layerStacks[d]).layers.length;for(var p=0;p<s;p++)(o=a.lb.getLayer(e))&&!o.readOnly&&a.layers[p].name===e&&a.layers[p].currentColor!==t&&(a!==i&&(a.layers[p].invalid=!0),a.layers[p].currentColor=t,a.layers[p].currentOp=r)}for(n=h.length,d=0;d<n;d++)h[d].getElementsByTagName("span")[0].style.backgroundColor=t}else console.error("Invalid or read only layer");else console.error("Invalid layer name")},e.prototype.colorInvalidLayers=function(e){function t(){(l=e.layers[n]).invalid&&(e.lb.setColor(l.name,l.currentColor,l.currentOp),l.invalid=!1),++n<r&&window.setTimeout(t,0)}var l=null,r=e.layers.length,n=0;t()},e.prototype.togglePreviewStack=function(e){var t=this,l=this.layerStacks[this.selectedStack],n=null;l&&l!==e&&((n=l.containEl).style.opacity=0,a(n,"wb-wheel-selected"),l.layerSelectEl.style.opacity=0),setTimeout(function(){n&&(o(n),o(l.layerSelectEl)),s(e.containEl,"wb-wheel-selected"),e.containEl.style.display="block",e.containEl.clientWidth,e.containEl.style.opacity=1,e.layerSelectEl.style.display="block",e.layerSelectEl.clientWidth,e.layerSelectEl.style.opacity=1,r(t.layerSelectWrap,t.layerOptsWrap),t.setStackTitle(e.name)},250)},e.prototype.renderCtrl=function(){i(this.ctrlWrap,"table-cell",!0),this.setCtrlTitle();var e=parseInt(this.wheelDims[1]-this.ctrlHeader.clientHeight);!isNaN(e)&&e>0&&(this.ctrl.style.height=e+"px")},e.prototype.renderStackSelector=function(){this.visibleStacks>1?i(this.selectorEl,"table-cell",!0):o(this.selectorEl,!0)},e.prototype.renderPreview=function(){if(this.wheelDims&&this.wheelDims.length){var e=this.wrapEl.getElementsByClassName("wb-wheel-preview-inner")[0];e.style.width=this.wheelDims[0]+"px",e.style.height=this.wheelDims[1]+"px"}},e.prototype.setCtrlTitle=function(e){this.ctrlTitle.innerText=e||this.dfltCtrlTitle},e.prototype.onBackClick=function(){this.setCtrlTitle(),o(this.backBtn),r(this.layerSelectWrap,this.layerOptsWrap)},e.prototype.resetLayer=function(e){for(var t=this.layerStacks.length,r=null,n=null,s=l(e),a=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+s),o=0;o<t;o++){(n=this.layerStacks[o]).lb.resetLayer(e),r=n.layers.length;for(var i=0;i<r;i++)n.layers[i].name===e&&(n.layers[i].currentColor="")}for(t=a.length,o=0;o<t;o++)a[o].getElementsByTagName("span")[0].style.backgroundColor=""},e.prototype.resetAllLayers=function(){for(var e=this.layerStacks.length,t=null,l=null,r=this.ctrlWrap.getElementsByClassName("wb-color"),n=0;n<e;n++){(l=this.layerStacks[n]).lb.resetAllLayers(),t=l.layers.length;for(var s=0;s<t;s++)l.layers[s].currentColor=""}for(e=r.length,n=0;n<e;n++)r[n].style.backgroundColor=""},e.prototype.validateLayer=function(e){return"object"!=typeof e?(console.error("Invalid layer for stack "+ls.name),!1):"string"!=typeof e.name||"string"!=typeof e.img?(console.error("Layer name and img properties invalid"),!1):(e.name=e.name.trim(),e.img=e.img.trim(),e.label="string"==typeof e.label&&e.label.trim()?e.label:e.name,e.readOnly=!!e.readOnly,e.options&&"object"==typeof e.options&&e.options.length||(self.defaultLayerOpts.length?e.options=self.defaultLayerOpts:(e.readOnly=!0,e.options=[])),e)},e.prototype.getLayerStack=function(e){return this.stackLookup.hasOwnProperty(e)?this.layerStacks[this.stackLookup[e]]:null},e.prototype.setStackTitle=function(e){"string"==typeof e&&(this.logo.innerText=e)},e.prototype.loadExternalJs=function(e){if(this.jsColorUrl){var t=this,l=document.createElement("script"),r=document.getElementsByTagName("head")[0];l.type="text/javascript",l.src=this.jsColorUrl,l.onload=function(){t.extJsLoaded||(t.extJsLoaded=!0,"function"==typeof e&&e.apply(t))},r.insertBefore(l,r.firstElementChild)}else this.extJsLoaded=!0},e.prototype.loadTemplate=function(e){var t=this,l=new XMLHttpRequest;l.onreadystatechange=function(){4===l.readyState&&(200===l.status?(t.tplHtml=l.responseText,t.tplLoaded=!0,"function"==typeof e&&e.apply(t)):console.error("xhr request for template failed"))},l.open("GET",this.tplUrl,!0),l.send(null)},e.prototype.loadStyles=function(e){if(this.cssUrl){var t=this,l=document.createElement("link"),r=document.getElementsByTagName("head")[0];l.rel="stylesheet",l.type="text/css",l.href=this.cssUrl,l.onload=function(){t.cssLoaded||(t.cssLoaded=!0,"function"==typeof e&&e.apply(t))},r.insertBefore(l,r.firstElementChild)}else this.cssLoaded=!0},e.prototype.getStackImage=function(e){var t=this.getLayerStack(e),l=null;return t&&t.lb&&(l=t.lb.getUnscaledImage()),l},e.prototype.onDownloadClick=function(e){var t=e.target,r=this.layerStacks[this.selectedStack],n=l(r.name)+".png",s="";r&&r.lb?(s=this.getStackImage(r.name),window.navigator.msSaveBlob?window.navigator.msSaveBlob(s,n):(t.href=s,t.download=n)):console.error("Cannot export: no stack selected")};var l=function(e){return e.replace(/\W+/g,"-")},r=function(e,t){t&&(t.style.display="none",t.style.opacity=0),e&&(e.style.display="block",e.clientWidth,e.style.opacity=1)},n=function(e,t){var l=new RegExp("(?:\\s|^)"+t+"(?:\\s|$)");return!!e.className.match(l)},s=function(e,t){-1===e.className.indexOf(t)&&(e.className+=" "+t,e.className=e.className.trim())},a=function(e,t){var l=null,r=0;"object"!=typeof t&&(t=[t]),r=t.length;for(var n=0;n<r;n++)l=new RegExp("(?:\\s|^)"+t[n]+"(?:\\s|$)"),e.className=e.className.replace(l," ")},o=function(e,t){e&&"object"==typeof e&&(t&&(e.style.opacity=0),e.style.display="none")},i=function(e,t,l){e&&"object"==typeof e&&(e.style.display=t||"block",l&&(e.style.opacity=1))};window.WheelBuilder=e}();