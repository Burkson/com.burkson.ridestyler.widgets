!function(){function e(e,t,l){var s=this;if(e&&"string"==typeof e)if(t&&"object"!=typeof t)console.error("Invalid layer stacks");else if(LayerBuilder&&"function"==typeof LayerBuilder){"object"!=typeof l&&(l={}),this.colorOp="multiply",this.pickerColor="FFFFFF",this.ctrlTitleText="Customize",this.wheelDims=[],this.imageType="image/png",this.defaultLayerOpts=null,this.cancelText="Cancel",this.confirmText="Confirm",this.onCancel=null,this.onConfirm=null;for(var a in l)this.hasOwnProperty(a)&&(this[a]=l[a]);if(this.dev=!!l.hasOwnProperty("dev")&&!!l.dev,this.containerId=e,this.container=document.getElementById(e),this.wrapId="wb-wrapper",this.smallWidth=900,this.smallestWidth=500,this.dirtyStacks=t,this.layerStacks=[],this.stackLookup={},this.visibleStacks=0,this.initPromise=new LBUtil.promise,this.asyncPromise=new LBUtil.promise,this.loadedPromise=new LBUtil.promise,this.appLoadedPromise=new LBUtil.promise,this.tplLoaded=!1,this.cssLoaded=!1,this.extJsLoaded=!1,this.cdnUrl="https://rawgit.com/Burkson/com.burkson.ridestyler.widgets/master/widgets/wheel-builder/dist/",this.urlPfx=this.dev?"src/":this.cdnUrl,this.tplUrl=this.urlPfx+"html/template.html",l.hasOwnProperty("cssUrl")?this.cssUrl="string"==typeof l.cssUrl&&l.cssUrl:this.cssUrl=this.dev?this.urlPfx+"css/wheelBuilder.css":this.urlPfx+"css/wheelBuilder.min.css",window.jscolor||(this.jsColorUrl=this.urlPfx+"js/jscolor.min.js"),this.tplHtml="",this.wrapEl=null,this.ctrlWrap=null,this.selectorEl=null,this.layerSelectWrap=null,this.layerOptsWrap=null,this.topBar=null,this.ctrlHeader=null,this.ctrlTitle=null,this.ctrl=null,this.backBtn=null,this.closeBtn=null,this.selectedStack=null,"object"==typeof l.wheelDims&&2===l.wheelDims.length){var r=parseInt(l.wheelDims[0]),i=parseInt(l.wheelDims[1]);isNaN(r)||isNaN(i)||(this.wheelDims=[r,i])}this.container?(s.initPromise.resolve(),s.onDomReady()):document.addEventListener("DOMContentLoaded",function(){s.container=document.getElementById(s.containerId),s.container?(s.initPromise.resolve(),s.onDomReady()):console.error("Container does not exist")})}else console.error("LayerBuilder not found");else console.error("Invalid container ID")}e.prototype.checkLoaded=function(){for(var e=this.layerStacks.length,t=0,l=0;l<e;l++)this.layerStacks[l].lb.loaded&&t++;t===e&&this.loadedPromise.resolve()},e.prototype.loaded=function(e){this.appLoadedPromise.done(function(){e.call()})},e.prototype.onDomReady=function(){var e=this.onAsyncComplete;null!=this.container?(this.loadExternalJs(e),this.loadStyles(e),this.loadTemplate(e)):console.error("Invalid container Id")},e.prototype.isAsyncComplete=function(){return this.tplLoaded&&this.cssLoaded&&this.extJsLoaded},e.prototype.onAsyncComplete=function(){this.isAsyncComplete()&&(this.initApp(),this.asyncPromise.resolve())},e.prototype.initApp=function(){var e=this,t=this.dirtyStacks.length;if(this.isAsyncComplete())if(this.tplHtml)if(this.container.innerHTML=this.tplHtml,this.wrapEl=document.getElementById(this.wrapId),this.wrapEl){this.ctrlWrap=this.wrapEl.getElementsByClassName("wb-ctrl-wrap")[0],this.layerSelectWrap=this.ctrlWrap.getElementsByClassName("wb-layer-select")[0],this.layerOptsWrap=this.ctrlWrap.getElementsByClassName("wb-layer-options")[0],this.selectorEl=this.wrapEl.getElementsByClassName("wb-wheel-selector")[0],this.topBar=this.wrapEl.getElementsByClassName("wb-top-bar")[0],this.logo=this.topBar.getElementsByClassName("wb-logo")[0],this.ctrlHeader=this.ctrlWrap.getElementsByClassName("wb-ctrl-header")[0],this.ctrlTitle=this.ctrlWrap.getElementsByClassName("wb-ctrl-title")[0],this.ctrl=this.ctrlWrap.getElementsByClassName("wb-ctrl")[0],this.backBtn=this.ctrlHeader.getElementsByClassName("wb-back-btn")[0],this.closeBtn=this.ctrlHeader.getElementsByClassName("wb-close-btn")[0],window.addEventListener("resize",function(){e.adjustLayout()}),this.backBtn.onclick=function(){e.onBackClick()},this.closeBtn.onclick=function(){LBUtil.hasClass(e.ctrlWrap,"wb-closed")?(LBUtil.removeClass(e.ctrlWrap,"wb-closed"),this.innerHTML="[-]"):(LBUtil.addClass(e.ctrlWrap,"wb-closed"),this.innerHTML="[+]")};for(var l=0;l<t;l++)this.addStack(this.dirtyStacks[l]);this.loadedPromise.done(function(){e.initTop(),e.renderCtrl(),e.renderStackSelector(),e.renderPreview(),e.appLoadedPromise.resolve()}),this.appLoadedPromise.done(function(){LBUtil.show(e.wrapEl,"block",!0)}),this.adjustLayout()}else console.error("Unable to select wrapper element #"+this.wrapId);else console.error("No template specified");else console.error("Template not loaded")},e.prototype.initTop=function(){var e=this,t=this.topBar.getElementsByClassName("wb-top-button-left")[0],l=this.topBar.getElementsByClassName("wb-top-button-right")[0],s=this.wrapEl.getElementsByClassName("wb-download")[0];this.onCancel?(t.innerText=this.cancelText,t.onclick=function(){e.onCancel.call()}):LBUtil.hide(t),this.onConfirm?(l.innerText=this.confirmText,l.onclick=function(){e.onConfirm.call()}):LBUtil.hide(l),s&&(s.onclick=function(t){e.onDownloadClick(t)}),LBUtil.show(this.topBar,"table",!0)},e.prototype.adjustLayout=function(){if(this.container){var e=this.container.offsetWidth;this.wrapEl&&(e<=this.smallestWidth?(LBUtil.hasClass(this.wrapEl,"wb-small")||LBUtil.addClass(this.wrapEl,"wb-small"),LBUtil.hasClass(this.wrapEl,"wb-smallest")||LBUtil.addClass(this.wrapEl,"wb-smallest")):e<=this.smallWidth?(LBUtil.hasClass(this.wrapEl,"wb-small")||LBUtil.addClass(this.wrapEl,"wb-small"),LBUtil.removeClass(this.wrapEl,"wb-smallest")):LBUtil.removeClass(this.wrapEl,["wb-small","wb-smallest"]))}},e.prototype.selectStack=function(e){this.layerStacks[this.selectedStack];var t=this.getStack(e);t.layerSelectEl||this.createLayerSelector(t,!0),this.togglePreviewStack(t),this.selectedStack=this.stackLookup[e]},e.prototype.createLayerSelector=function(e){var t=this,l=e.layers.length,s="",a=null,r=null,i=null,o=null,n=null,c=document.createElement("ul");LBUtil.addClass(c,"wb-layer-selector");for(var d=0;d<l;d++)(a=e.layers[d]).readOnly||(s=LBUtil.nonAlpha2Dash(a.name),o=document.createElement("a"),n=document.createElement("li"),r=document.createElement("span"),i=document.createElement("span"),LBUtil.addClass(n,"wb-ctrl-layer"),LBUtil.addClass(n,"wb-ctrl-layer-"+s),LBUtil.addClass(r,"wb-color"),a.currentColor&&(r.style.backgroundColor=a.currentColor),i.innerText=a.name+" +",o.appendChild(r),o.appendChild(i),o.setAttribute("data-layeridx",d),o.onclick=function(l){var s=l.target,a=null;"A"!==s.tagName&&(s=s.parentElement),a=parseInt(s.getAttribute("data-layeridx")),t.showLayerOpts(e,a),LBUtil.toggle(t.layerOptsWrap,t.layerSelectWrap)},n.appendChild(o),c.appendChild(n));n=document.createElement("li"),e.layerSelectEl=c,this.layerSelectWrap.appendChild(c)},e.prototype.showLayerOpts=function(e,t){var l=this,s=e.layers[t],a=(LBUtil.nonAlpha2Dash(s.name),s.options),r=null,i=null,o=null,n=null,c=null,d=null,h=null,p=null,m=null,y="";if("object"==typeof a&&a.length){this.setCtrlTitle("Options"),this.layerOptsWrap.innerHTML="",r=document.createElement("ul"),(n=document.createElement("li")).innerText=s.name+" -",LBUtil.show(n),r.appendChild(n);for(var u=0,f=a.length;u<f;u++)"string"==typeof a[u].name&&a[u].name.trim()?"string"==typeof a[u].color&&a[u].color.trim()?(y="string"!=typeof a[u].operation||-1===e.lb.getOperations().indexOf(a[u].operation.toLowerCase())?this.colorOp:a[u].operation.trim().toLowerCase(),i=document.createElement("li"),d=document.createElement("span"),c=document.createElement("a"),LBUtil.addClass(d,"wb-color"),d.style.backgroundColor=a[u].color.trim(),c.appendChild(d),c.onclick=function(e){var t=e.target,a="",r="";"A"!==t.tagName&&(t=t.parentElement),a=t.getAttribute("data-color"),r=t.getAttribute("data-operation"),p.fromString(a),l.setLayerColor(s.name,a,r)},c.setAttribute("data-color",a[u].color.trim()),c.setAttribute("data-operation",y),c.setAttribute("title",a[u].name),i.appendChild(c),r.appendChild(i)):console.error("Invalid color provided for layer "+s.name+" option "+a.name):console.error("Invalid name provided for layer "+s.name+" option");this.layerOptsWrap.appendChild(r),h=document.createElement("input"),LBUtil.addClass(h,"jscolor"),d=document.createElement("span"),LBUtil.addClass(d,"wb-color"),LBUtil.addClass(d,"wb-color-custom"),i=document.createElement("li"),LBUtil.addClass(i,"wb-custom-color-wrap"),m=document.createElement("a"),LBUtil.addClass(m,"wb-js-color"),m.innerHTML="<span>&nbsp;Custom</span>",m.setAttribute("title","Custom Color"),m.onclick=function(){p.show()},(p=new jscolor(h,{hash:!0,closable:!0})).fromString(s.currentColor?s.currentColor:this.pickerColor),p.onFineChange=function(){var e=this.valueElement.parentElement.getElementsByClassName("wb-color-custom")[0],t=this.toHEXString();l.setLayerColor(s.name,t),e.style.backgroundColor=t},m.insertBefore(d,m.firstElementChild),m.appendChild(h),i.appendChild(m),r.appendChild(i),i=document.createElement("li"),d=document.createElement("span"),(o=document.createElement("a")).innerHTML="<span> Reset</span>",LBUtil.addClass(d,"wb-color"),LBUtil.addClass(d,"wb-color-reset"),LBUtil.addClass(i,"wb-reset-wrap"),o.insertBefore(d,o.firstElementChild),i.appendChild(o),o.onclick=function(){p.fromString(l.pickerColor),d.style.backgroundColor="#"+l.pickerColor,l.resetLayer(s.name)},r.appendChild(i),LBUtil.show(this.backBtn,"inline"),LBUtil.toggle(this.layerOptsWrap,this.layerSelectWrap)}},e.prototype.addStack=function(e){var t=this;e&&"object"==typeof e?this.asyncPromise.done(function(){var l=t.getStack(e.name),s=t.wrapEl.getElementsByClassName("wb-wheel-preview-inner")[0],a=null,r=null,i=null,o=null,n="";if(e.name&&e.name.trim())if(e.name=e.name.trim(),n=LBUtil.nonAlpha2Dash(e.name.toLowerCase()),e.visible=!!e.visible,e.selected=!!e.selected,"object"==typeof e.layers&&e.layers.length){for(var c=0,d=e.layers.length;c<d;c++)e.layers[c]=t.validateLayer(e.layers[c]),e.layers[c]||e.layers.splice(c,1);l?((a=t.wrapEl.getElementById("wb-wheel-"+n)).innerHTML="",i=t.stackLookup[e.name],t.layerStacks[i]=e):((a=document.createElement("div")).id="wb-wheel-"+n,s.appendChild(a),i=t.layerStacks.length,t.stackLookup[e.name]=i,t.layerStacks[i]=e),LBUtil.addClass(a,"wb-wheel"),(r=new LayerBuilder(a.id,{dimensions:t.wheelDims})).setLayers(e.layers).done(function(){o=r.getDimensions(),a.style.width=o.width+"px",a.style.height=o.height+"px",e.visible&&t.addStackSelector(e),e.selected||LBUtil.hide(a)}),r.imgLoadPromise.done(function(){t.checkLoaded()}),t.layerStacks[i].lb=r,t.layerStacks[i].containEl=a,t.layerStacks[i].idx=i,e.visible&&(t.visibleStacks++,e.selected&&(LBUtil.addClass(a,"wb-wheel-selected"),t.selectedStack=i,t.selectStack(e.name)))}else console.error("No layers provided");else console.error("No name provided for layer stack")}):console.error("Invalid layer stack")},e.prototype.addStackSelector=function(e){var t=this,l=e.lb.getImage(),s=new Image,a=document.createElement("li"),r=null;s.src=l,a.setAttribute("data-stackname",e.name),a.appendChild(s),a.onclick=function(l){var s=l.target,a=s,r=t.selectorEl.getElementsByClassName("wb-stack-selected")[0];"li"!==s.tagName.toLowerCase()&&(a=s.parentElement),LBUtil.removeClass(r,"wb-stack-selected"),t.selectStack(e.name),LBUtil.addClass(a,"wb-stack-selected")},e.selected&&LBUtil.addClass(a,"wb-stack-selected"),this.selectorEl.children.length?(r=this.selectorEl.children[e.idx])?this.selectorEl.insertBefore(a,r):e.idx>=this.selectorEl.children.length?this.selectorEl.appendChild(a):this.selectorEl.insertBefore(a,this.selectorEl.firstChild):this.selectorEl.appendChild(a)},e.prototype.setLayerColor=function(e,t,l){var s=this.layerStacks.length,a=null,r=null,i=null,o=this.layerStacks[this.selectedStack],n=LBUtil.nonAlpha2Dash(e),c=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+n);if("string"==typeof e&&e.trim())if(t=t.toUpperCase(),(i=o.lb.getLayer(e))&&!i.readOnly){o.lb.setColor(e,t,l);for(var d=0;d<s;d++){a=(r=this.layerStacks[d]).layers.length;for(var h=0;h<a;h++)(i=r.lb.getLayer(e))&&!i.readOnly&&r.layers[h].name===e&&r.layers[h].currentColor!==t&&(r!==o&&r.lb.setColor(e,t,l),r.layers[h].currentColor=t,r.layers[h].currentOp=l)}for(s=c.length,d=0;d<s;d++)c[d].getElementsByTagName("span")[0].style.backgroundColor=t;this.updateStackSelector()}else console.error("Invalid or read only layer");else console.error("Invalid layer name")},e.prototype.updateStackSelector=function(){for(var e=this.selectorEl.getElementsByTagName("li"),t=e.length,l=null,s=null,a="",r="",i="",o=0;o<t;o++)a=e[o].getAttribute("data-stackname"),l=this.getStack(a),s=e[o].getElementsByTagName("img")[0],"none"===(i=l.containEl.style.display)&&(l.containEl.style.display="block"),r=l.lb.getImage(),l.containEl.style.display=i,s.setAttribute("src",r)},e.prototype.togglePreviewStack=function(e){var t=this,l=this.layerStacks[this.selectedStack],s=null;l&&l!==e&&((s=l.containEl).style.opacity=0,LBUtil.removeClass(s,"wb-wheel-selected"),l.layerSelectEl.style.opacity=0),setTimeout(function(){s&&(LBUtil.hide(s),LBUtil.hide(l.layerSelectEl)),LBUtil.addClass(e.containEl,"wb-wheel-selected"),e.containEl.style.display="block",e.containEl.clientWidth,e.containEl.style.opacity=1,e.layerSelectEl.style.display="block",e.layerSelectEl.clientWidth,e.layerSelectEl.style.opacity=1,LBUtil.toggle(t.layerSelectWrap,t.layerOptsWrap),t.setStackTitle(e.name)},250)},e.prototype.renderCtrl=function(){LBUtil.show(this.ctrlWrap,"table-cell",!0,.87),this.setCtrlTitle()},e.prototype.renderStackSelector=function(){this.visibleStacks>1?LBUtil.show(this.selectorEl,"table-cell",!0):LBUtil.hide(this.selectorEl,!0)},e.prototype.renderPreview=function(){if(this.wheelDims&&this.wheelDims.length){var e=this.wrapEl.getElementsByClassName("wb-wheel-preview-inner")[0];e.style.width=this.wheelDims[0]+"px",e.style.height=this.wheelDims[1]+"px"}},e.prototype.setCtrlTitle=function(e){this.ctrlTitle.innerText=e||this.ctrlTitleText},e.prototype.onBackClick=function(){this.setCtrlTitle(),LBUtil.hide(this.backBtn),LBUtil.toggle(this.layerSelectWrap,this.layerOptsWrap)},e.prototype.resetLayer=function(e){for(var t=this.layerStacks.length,l=null,s=null,a=LBUtil.nonAlpha2Dash(e),r=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+a),i=0;i<t;i++){(s=this.layerStacks[i]).lb.resetLayer(e),l=s.layers.length;for(var o=0;o<l;o++)s.layers[o].name===e&&(s.layers[o].currentColor="")}for(t=r.length,i=0;i<t;i++)r[i].getElementsByTagName("span")[0].style.backgroundColor="";this.updateStackSelector()},e.prototype.resetAllLayers=function(){for(var e=this.layerStacks.length,t=null,l=null,s=this.layerSelectWrap.getElementsByClassName("wb-color"),a=0;a<e;a++){(l=this.layerStacks[a]).lb.resetAllLayers(),t=l.layers.length;for(var r=0;r<t;r++)l.layers[r].currentColor=""}for(e=s.length,a=0;a<e;a++)s[a].style.backgroundColor="";this.updateStackSelector()},e.prototype.validateLayer=function(e){return"object"!=typeof e?(console.error("Invalid layer for stack "+ls.name),!1):"string"!=typeof e.name||"string"!=typeof e.img?(console.error("Layer name and img properties invalid"),!1):(e.name=e.name.trim(),e.img=e.img.trim(),e.label="string"==typeof e.label&&e.label.trim()?e.label:e.name,e.readOnly=!!e.readOnly,e.options&&"object"==typeof e.options&&e.options.length||(self.defaultLayerOpts.length?e.options=self.defaultLayerOpts:(e.readOnly=!0,e.options=[])),e)},e.prototype.getStack=function(e){return this.stackLookup.hasOwnProperty(e)?this.layerStacks[this.stackLookup[e]]:null},e.prototype.setStackTitle=function(e){"string"==typeof e&&(this.logo.innerText=e)},e.prototype.loadExternalJs=function(e){if(this.jsColorUrl){var t=this,l=document.createElement("script"),s=document.getElementsByTagName("head")[0];l.type="text/javascript",l.src=this.jsColorUrl,l.onload=function(){t.extJsLoaded||(t.extJsLoaded=!0,"function"==typeof e&&e.apply(t))},s.insertBefore(l,s.firstElementChild)}else this.extJsLoaded=!0},e.prototype.loadTemplate=function(e){var t=this,l=new XMLHttpRequest;l.onreadystatechange=function(){4===l.readyState&&(200===l.status?(t.tplHtml=l.responseText,t.tplLoaded=!0,"function"==typeof e&&e.apply(t)):console.error("xhr request for template failed"))},l.open("GET",this.tplUrl,!0),l.send(null)},e.prototype.loadStyles=function(e){if(this.cssUrl){var t=this,l=document.createElement("link"),s=document.getElementsByTagName("head")[0];l.rel="stylesheet",l.type="text/css",l.href=this.cssUrl,l.onload=function(){t.cssLoaded||(t.cssLoaded=!0,"function"==typeof e&&e.apply(t))},s.insertBefore(l,s.firstElementChild)}else this.cssLoaded=!0},e.prototype.getImage=function(e,t){var l=this.getStack(e),s=null;return l&&l.lb&&(t="string"==typeof t?t.trim():this.imageType,s=l.lb.getUnscaledImage(t)),s},e.prototype.onDownloadClick=function(e){var t=e.target,l=this.layerStacks[this.selectedStack],s=LBUtil.nonAlpha2Dash(l.name)+".png",a="";l&&l.lb?(a=this.getImage(l.name,this.imageType),window.navigator.msSaveBlob?window.navigator.msSaveBlob(a,s):(t.href=a,t.download=s)):console.error("Cannot export: no stack selected")},window.WheelBuilder=e}();