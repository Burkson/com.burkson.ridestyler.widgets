!function(){function e(e,l,r){var s=this;if(e&&"string"==typeof e)if(l&&"object"!=typeof l)console.error("Invalid layer stacks");else if(LayerBuilder&&"function"==typeof LayerBuilder){if("object"!=typeof r&&(r={}),r.hasOwnProperty("defaultLayerOpts")&&r.defaultLayerOpts.length?this.defaultLayerOpts=r.defaultLayerOpts:this.defaultLayerOpts=null,this.dev=!!r.hasOwnProperty("dev")&&!!r.dev,this.dfltWheelDims=[300,300],r.hasOwnProperty("wheelDims")&&"object"==typeof r.wheelDims&&2===r.wheelDims.length){var a=parseInt(r.wheelDims[0]),n=parseInt(r.wheelDims[1]);isNaN(a)||isNaN(n)?this.wheelDims=this.dfltWheelDims:this.wheelDims=[a,n]}else this.wheelDims=this.dfltWheelDims;this.containerId=e,this.container=document.getElementById(e),this.smallWidth=880,this.smallestWidth=480,this.dirtyStacks=l,this.layerStacks=[],this.stackLookup={},this.visibleStacks=0,this.initPromise=new t,this.asyncPromise=new t,this.loadedPromise=new t,this.tplLoaded=!1,this.cssLoaded=!1,this.extJsLoaded=!1,this.cdnUrl="https://gitcdn.xyz/repo/Burkson/com.burkson.ridestyler.widgets/master/widgets/wheel-builder/dist/",this.urlPfx=this.dev?"src/":this.cdnUrl,this.tplUrl=this.urlPfx+"html/template.html",r.hasOwnProperty("cssUrl")?this.cssUrl=!(!r.cssUrl||"string"!=typeof r.cssUrl)&&r.cssUrl:this.cssUrl=this.dev?this.urlPfx+"css/wheelBuilder.css":this.urlPfx+"css/wheelBuilder.min.css",window.jscolor||(this.jsColorUrl=this.urlPfx+"js/jscolor.min.js"),this.tplHtml="",this.wrapEl=null,this.ctrlEl=null,this.selectorEl=null,this.layerSelectWrap=null,this.layerOptsWrap=null,this.selectedStack=null,this.dfltColorOp="multiply",this.dfltPickerColor="FFFFFF",this.container?(s.initPromise.resolve(),s.onDomReady()):document.addEventListener("DOMContentLoaded",function(){s.container=document.getElementById(s.containerId),s.initPromise.resolve(),s.onDomReady()})}else console.error("LayerBuilder not found");else console.error("Invalid container ID")}function t(){function e(e){a.push(e),t()}function t(){if(r!==l.pending)for(;a.length>0;){var e=a.shift();r===l.resolved&&"function"==typeof e.done?e.done(s):r===l.rejected&&"function"==typeof e.fail&&e.fail(s),"function"==typeof e.always&&e.always(s)}}var l={pending:0,resolved:1,rejected:2},r=l.pending,s=null,a=[];return{state:function(){return r},value:function(){return s},changeState:function(e,a){return r===e?console.error("Cannot changeState to same state: "+e):r!==l.pending?console.error("Cannot changeState when promise is finalized."):(r=e,s=a,t(),r)},resolve:function(e){this.changeState(l.resolved,e)},reject:function(e){this.changeState(l.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return r===l.resolved},isRejected:function(){return r===l.rejected}}}e.prototype.checkLoaded=function(){for(var e=this.layerStacks.length,t=0,l=0;l<e;l++)this.layerStacks[l].lb.loaded&&t++;t===e&&this.loadedPromise.resolve()},e.prototype.loaded=function(e){this.loadedPromise.done(function(){e.call()})},e.prototype.onDomReady=function(){var e=this.onAsyncComplete;null!=this.container?(this.loadExternalJs(e),this.loadStyles(e),this.loadTemplate(e)):console.error("Invalid container Id")},e.prototype.isAsyncComplete=function(){return this.tplLoaded&&this.cssLoaded&&this.extJsLoaded},e.prototype.onAsyncComplete=function(){this.isAsyncComplete()&&(this.initApp(),this.asyncPromise.resolve())},e.prototype.initApp=function(){var e=this,t=this.dirtyStacks.length;if(this.isAsyncComplete()){this.container.innerHTML=this.tplHtml,this.wrapEl=document.getElementById("wb-wrapper"),this.ctrlEl=this.wrapEl.getElementsByClassName("wb-ctrl-wrap")[0],this.layerSelectWrap=this.ctrlEl.getElementsByClassName("wb-layer-select")[0],this.layerOptsWrap=this.ctrlEl.getElementsByClassName("wb-layer-options")[0],this.selectorEl=this.wrapEl.getElementsByClassName("wb-wheel-selector")[0],window.addEventListener("resize",function(){e.adjustLayout()}),this.ctrlEl.getElementsByClassName("wb-download")[0].onclick=function(t){e.onDownloadClick(t)};for(var l=0;l<t;l++)this.addLayerStack(this.dirtyStacks[l]);this.showCtrl(),this.adjustLayout()}else console.error("Template not loaded, unable to initialize app")},e.prototype.adjustLayout=function(){if(this.container){var e=this.container.offsetWidth;this.wrapEl&&(e<=this.smallestWidth?(s(this.wrapEl,"wb-small")||a(this.wrapEl,"wb-small"),s(this.wrapEl,"wb-smallest")||a(this.wrapEl,"wb-smallest")):e<=this.smallWidth?(s(this.wrapEl,"wb-small")||a(this.wrapEl,"wb-small"),n(this.wrapEl,"wb-smallest")):n(this.wrapEl,["wb-small","wb-smallest"]))}},e.prototype.selectStack=function(e){this.layerStacks[this.selectedStack];var t=this.getLayerStack(e);t.layerSelectEl||this.createLayerSelector(t,!0),this.togglePreviewStack(t),this.selectedStack=this.stackLookup[e]},e.prototype.createLayerSelector=function(e){var t=this,s=e.layers.length,n="",o=null,i=null,c=null,d=null,p=null,h=null,y=null,m=document.createElement("ul");a(m,"wb-layer-selector");for(var u=0;u<s;u++)(o=e.layers[u]).readOnly||(n=l(o.name),d=document.createElement("a"),p=document.createElement("li"),i=document.createElement("span"),c=document.createElement("span"),a(p,"wb-ctrl-layer"),a(p,"wb-ctrl-layer-"+n),a(i,"wb-color"),o.currentColor&&(i.style.backgroundColor=o.currentColor),c.innerText=o.name,d.appendChild(i),d.appendChild(c),d.setAttribute("data-layeridx",u),d.onclick=function(l){var s=l.target,a=null;"A"!==s.tagName&&(s=s.parentElement),a=parseInt(s.getAttribute("data-layeridx")),t.showLayerOpts(e,a),r(t.layerOptsWrap,t.layerSelectWrap)},p.appendChild(d),m.appendChild(p));p=document.createElement("li"),(h=document.createElement("button")).innerText="Reset All",h.onclick=function(){t.resetAllLayers()},a(h,"wb-reset-all"),(y=document.createElement("div")).appendChild(h),a(y,"wb-button-wrap"),e.layerSelectEl=m,this.layerSelectWrap.appendChild(m),this.layerSelectWrap.appendChild(y)},e.prototype.togglePreviewStack=function(e){var t=this,l=this.layerStacks[this.selectedStack],s=null;l&&l!==e&&((s=l.containEl).style.opacity=0,n(s,"wb-wheel-selected"),l.layerSelectEl.style.opacity=0),setTimeout(function(){s&&(s.style.display="none",l.layerSelectEl.style.display="none"),a(e.containEl,"wb-wheel-selected"),e.containEl.style.display="block",e.containEl.clientWidth,e.containEl.style.opacity=1,e.layerSelectEl.style.display="block",e.layerSelectEl.clientWidth,e.layerSelectEl.style.opacity=1,r(t.layerSelectWrap,t.layerOptsWrap),t.setStackTitle(e.name)},300)},e.prototype.showCtrl=function(){this.ctrlEl.style.opacity=1,this.ctrlEl.style.display="block"},e.prototype.showLayerOpts=function(e,t){var s=this,n=e.layers[t],o=(l(n.name),n.options),i=null,c=null,d=null,p=null,h=null,y=null,m=null,u=null,f=null,w=null,g=null,E="";if("object"==typeof o&&o.length){this.layerOptsWrap.innerHTML="",i=document.createElement("ul"),c=document.createElement("button"),d=document.createElement("button");for(var b=0,k=o.length;b<k;b++)"string"==typeof o[b].name&&o[b].name.trim()?"string"==typeof o[b].color&&o[b].color.trim()?(E="string"!=typeof o[b].operation||-1===e.lb.getOperations().indexOf(o[b].operation.toLowerCase())?this.dfltColorOp:o[b].operation.trim().toLowerCase(),h=document.createElement("li"),m=document.createElement("span"),u=document.createElement("span"),y=document.createElement("a"),a(m,"wb-color"),m.style.backgroundColor=o[b].color.trim(),y.appendChild(m),u.innerHTML=o[b].name.trim(),y.appendChild(u),y.onclick=function(e){var t=e.target,l="",r="";"A"!==t.tagName&&(t=t.parentElement),l=t.getAttribute("data-color"),r=t.getAttribute("data-operation"),w.fromString(l),s.setLayerColor(n.name,l,r)},y.setAttribute("data-color",o[b].color.trim()),y.setAttribute("data-operation",E),h.appendChild(y),i.appendChild(h)):console.error("Invalid color provided for layer "+n.name+" option "+o.name):console.error("Invalid name provided for layer "+n.name+" option");this.layerOptsWrap.appendChild(i),f=document.createElement("input"),a(f,"jscolor"),m=document.createElement("span"),a(m,"wb-color"),h=document.createElement("li"),a(h,"wb-custom-color"),g=document.createElement("a"),a(g,"wb-js-color"),g.innerHTML="<span>Custom color</span>",g.onclick=function(){w.show()},(w=new jscolor(f,{hash:!0,closable:!0})).fromString(n.currentColor?n.currentColor:this.dfltPickerColor),w.onFineChange=function(){var e=this.toHEXString();s.setLayerColor(n.name,e),m.style.backgroundColor=e},g.appendChild(f),g.insertBefore(m,g.firstElementChild),h.appendChild(g),i.appendChild(h),p=document.createElement("div"),a(p,"wb-button-wrap"),c.innerText="Back",c.onclick=function(){r(s.layerSelectWrap,s.layerOptsWrap)},d.innerText="Reset",d.onclick=function(){w.fromString(s.dfltPickerColor),m.style.backgroundColor="#"+s.dfltPickerColor,s.resetLayer(n.name)},p.appendChild(c),p.appendChild(d),this.layerOptsWrap.appendChild(p),r(this.layerOptsWrap,this.layerSelectWrap)}},e.prototype.addLayerStack=function(e){var t=this;e&&"object"==typeof e?this.asyncPromise.done(function(){var s=t.getLayerStack(e.name),n=t.wrapEl.getElementsByClassName("wb-wheel-preview")[0],o=null,i=null,c="";if(e.name&&e.name.trim())if(e.name=e.name.trim(),c=l(e.name.toLowerCase()),e.visible=!!e.visible,e.selected=!!e.selected,"object"==typeof e.layers&&e.layers.length){for(var d=0,p=e.layers.length;d<p;d++)e.layers[d]=t.validateLayer(e.layers[d]),e.layers[d]||e.layers.splice(d,1);s?((o=t.wrapEl.getElementById("wb-wheel-"+c)).innerHTML="",idx=t.stackLookup[e.name],t.layerStacks[idx]=e):((o=document.createElement("div")).id="wb-wheel-"+c,n.appendChild(o),idx=t.layerStacks.length,t.stackLookup[e.name]=idx,t.layerStacks[idx]=e),a(o,"wb-wheel"),(i=new LayerBuilder(o.id,{dimensions:t.wheelDims})).setLayers(e.layers).done(function(){dims=i.getDimensions(),o.style.width=dims.width+"px",o.style.height=dims.height+"px",e.visible&&t.addStackSelector(e),e.selected||r(null,o)}),i.imgLoadPromise.done(function(){t.checkLoaded()}),t.layerStacks[idx].lb=i,t.layerStacks[idx].containEl=o,t.layerStacks[idx].idx=idx,e.visible&&(t.visibleStacks++,e.selected&&(a(o,"wb-wheel-selected"),t.selectedStack=idx,t.selectStack(e.name)))}else console.error("No layers provided");else console.error("No name provided for layer stack")}):console.error("Invalid layer stack")},e.prototype.addStackSelector=function(e){var t=this,l=e.lb.getImage(),r=new Image,s=document.createElement("li");if(r.src=l,s.appendChild(r),s.onclick=function(l){var r=l.target,s=r,o=t.selectorEl.getElementsByClassName("wb-stack-selected")[0];"li"!==r.tagName.toLowerCase&&(s=r.parentElement),n(o,"wb-stack-selected"),t.selectStack(e.name),a(s,"wb-stack-selected")},e.selected&&a(s,"wb-stack-selected"),this.selectorEl.children.length){var o=this.selectorEl.children[e.idx];o?this.selectorEl.insertBefore(s,o):e.idx>=this.selectorEl.children.length?this.selectorEl.appendChild(s):this.selectorEl.insertBefore(s,this.selectorEl.firstChild)}else this.selectorEl.appendChild(s);this.visibleStacks>1?this.selectorEl.style.opacity=1:this.selectorEl.style.opacity=0},e.prototype.setLayerColor=function(e,t,r){var s=this.layerStacks.length,a=null,n=null,o=null,i=l(e),c=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+i);if("string"==typeof e&&e.trim()){for(var d=0;d<s;d++)if(n=this.layerStacks[d],(o=n.lb.getLayer(e))&&!o.readOnly){n.lb.setColor(e,t,r),a=n.layers.length;for(var p=0;p<a;p++)n.layers[p].name===e&&(n.layers[p].currentColor=t)}for(s=c.length,d=0;d<s;d++)c[d].getElementsByTagName("span")[0].style.backgroundColor=t}else console.error("Invalid layer name")},e.prototype.resetLayer=function(e){for(var t=this.layerStacks.length,r=null,s=null,a=l(e),n=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+a),o=0;o<t;o++){(s=this.layerStacks[o]).lb.resetLayer(e),r=s.layers.length;for(var i=0;i<r;i++)s.layers[i].name===e&&(s.layers[i].currentColor="")}for(t=n.length,o=0;o<t;o++)n[o].getElementsByTagName("span")[0].style.backgroundColor=""},e.prototype.resetAllLayers=function(){for(var e=this.layerStacks.length,t=null,l=null,r=this.ctrlEl.getElementsByClassName("wb-color"),s=0;s<e;s++){(l=this.layerStacks[s]).lb.resetAllLayers(),t=l.layers.length;for(var a=0;a<t;a++)l.layers[a].currentColor=""}for(e=r.length,s=0;s<e;s++)r[s].style.backgroundColor=""},e.prototype.validateLayer=function(e){return"object"!=typeof e?(console.error("Invalid layer for stack "+ls.name),!1):"string"!=typeof e.name||"string"!=typeof e.img?(console.error("Layer name and img properties invalid"),!1):(e.name=e.name.trim(),e.img=e.img.trim(),e.label="string"==typeof e.label&&e.label.trim()?e.label:e.name,e.readOnly=!!e.readOnly,e.options&&"object"==typeof e.options&&e.options.length||(self.defaultLayerOpts.length?e.options=self.defaultLayerOpts:(e.readOnly=!0,e.options=[])),e)},e.prototype.getLayerStack=function(e){return this.stackLookup.hasOwnProperty(e)?this.layerStacks[this.stackLookup[e]]:null},e.prototype.setStackTitle=function(e){"string"==typeof e&&(this.ctrlEl.getElementsByClassName("wb-ctrl-title")[0].innerHTML=e)},e.prototype.loadExternalJs=function(e){if(this.jsColorUrl){var t=this,l=document.createElement("script"),r=document.getElementsByTagName("head")[0];l.type="text/javascript",l.src=this.jsColorUrl,l.onload=function(){t.extJsLoaded||(t.extJsLoaded=!0,"function"==typeof e&&e.apply(t))},r.insertBefore(l,r.firstElementChild)}else this.extJsLoaded=!0},e.prototype.loadTemplate=function(e){var t=this,l=new XMLHttpRequest;l.onreadystatechange=function(){4===l.readyState&&(200===l.status?(t.tplHtml=l.responseText,t.tplLoaded=!0,"function"==typeof e&&e.apply(t)):console.error("xhr request for template failed"))},l.open("GET",this.tplUrl,!0),l.send(null)},e.prototype.loadStyles=function(e){if(this.cssUrl){var t=this,l=document.createElement("link"),r=document.getElementsByTagName("head")[0];l.rel="stylesheet",l.type="text/css",l.href=this.cssUrl,l.onload=function(){t.cssLoaded||(t.cssLoaded=!0,"function"==typeof e&&e.apply(t))},r.insertBefore(l,r.firstElementChild)}else this.cssLoaded=!0},e.prototype.getStackImage=function(e){var t=this.getLayerStack(e),l=null;return t&&t.lb&&(l=t.lb.getUnscaledImage()),l},e.prototype.onDownloadClick=function(e){var t=e.target,r=this.layerStacks[this.selectedStack],s=l(r.name)+".png",a="";r&&r.lb?(a=this.getStackImage(r.name),window.navigator.msSaveBlob?window.navigator.msSaveBlob(a,s):(t.href=a,t.download=s)):console.error("Cannot export: no stack selected")};var l=function(e){return e.replace(/\W+/g,"-")},r=function(e,t){t&&(t.style.display="none",t.style.opacity=0),e&&(e.style.display="block",e.clientWidth,e.style.opacity=1)},s=function(e,t){var l=new RegExp("(?:\\s|^)"+t+"(?:\\s|$)");return!!e.className.match(l)},a=function(e,t){-1===e.className.indexOf(t)&&(e.className+=" "+t,e.className=e.className.trim())},n=function(e,t){var l=null,r=0;"object"!=typeof t&&(t=[t]),r=t.length;for(var s=0;s<r;s++)l=new RegExp("(?:\\s|^)"+t[s]+"(?:\\s|$)"),e.className=e.className.replace(l," ")};window.WheelBuilder=e}();