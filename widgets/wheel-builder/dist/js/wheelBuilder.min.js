!function(){function e(e,l,a){var s=this;if(e&&"string"==typeof e)if(l&&"object"!=typeof l)console.error("Invalid layer stacks");else if(LayerBuilder&&"function"==typeof LayerBuilder){if("object"!=typeof a&&(a={}),a.hasOwnProperty("defaultLayerOpts")&&a.defaultLayerOpts.length?this.defaultLayerOpts=a.defaultLayerOpts:this.defaultLayerOpts=null,this.dev=!!a.hasOwnProperty("dev")&&!!a.dev,this.dfltWheelDims=[300,300],a.hasOwnProperty("wheelDims")&&"object"==typeof a.wheelDims&&2===a.wheelDims.length){var r=parseInt(a.wheelDims[0]),n=parseInt(a.wheelDims[1]);isNaN(r)||isNaN(n)?this.wheelDims=this.dfltWheelDims:this.wheelDims=[r,n]}else this.wheelDims=this.dfltWheelDims;this.containerId=e,this.container=document.getElementById(e),this.smallWidth=880,this.smallestWidth=480,this.dirtyStacks=l,this.layerStacks=[],this.stackLookup={},this.visibleStacks=0,this.initPromise=new t,this.asyncPromise=new t,this.loadedPromise=new t,this.tplLoaded=!1,this.cssLoaded=!1,this.urlPfx=this.dev?"src/":"https://gitcdn.xyz/repo/Burkson/com.burkson.ridestyler.widgets/master/widgets/wheel-builder/dist/",this.tplUrl=this.urlPfx+"html/template.html",a.hasOwnProperty("cssUrl")?this.cssUrl=!(!a.cssUrl||"string"!=typeof a.cssUrl)&&a.cssUrl:this.cssUrl=this.dev?this.urlPfx+"css/wheelBuilder.css":this.urlPfx+"css/wheelBuilder.min.css",this.tplHtml="",this.wrapEl=null,this.ctrlEl=null,this.selectorEl=null,this.layerSelectWrap=null,this.layerOptsWrap=null,this.selectedStack=null,this.dfltColorOp="multiply",this.container?(s.initPromise.resolve(),s.onDomReady()):document.addEventListener("DOMContentLoaded",function(){s.container=document.getElementById(s.containerId),s.initPromise.resolve(),s.onDomReady()})}else console.error("LayerBuilder not found");else console.error("Invalid container ID")}function t(){function e(e){r.push(e),t()}function t(){if(a!==l.pending)for(;r.length>0;){var e=r.shift();a===l.resolved&&"function"==typeof e.done?e.done(s):a===l.rejected&&"function"==typeof e.fail&&e.fail(s),"function"==typeof e.always&&e.always(s)}}var l={pending:0,resolved:1,rejected:2},a=l.pending,s=null,r=[];return{state:function(){return a},value:function(){return s},changeState:function(e,r){return a===e?console.error("Cannot changeState to same state: "+e):a!==l.pending?console.error("Cannot changeState when promise is finalized."):(a=e,s=r,t(),a)},resolve:function(e){this.changeState(l.resolved,e)},reject:function(e){this.changeState(l.rejected,e)},always:function(t){return e({always:t}),this},done:function(t){return e({done:t}),this},fail:function(t){return e({fail:t}),this},isResolved:function(){return a===l.resolved},isRejected:function(){return a===l.rejected}}}e.prototype.checkLoaded=function(){for(var e=this.layerStacks.length,t=0,l=0;l<e;l++)this.layerStacks[l].lb.loaded&&t++;t===e&&this.loadedPromise.resolve()},e.prototype.loaded=function(e){this.loadedPromise.done(function(){e.call()})},e.prototype.onDomReady=function(){var e=this.onAsyncComplete;null!=this.container?(this.loadStyles(e),this.loadTemplate(e)):console.error("Invalid container Id")},e.prototype.onAsyncComplete=function(){this.tplLoaded&&this.cssLoaded&&(this.initApp(),this.asyncPromise.resolve())},e.prototype.initApp=function(){var e=this,t=this.dirtyStacks.length;if(this.tplLoaded&&this.cssLoaded){this.container.innerHTML=this.tplHtml,this.wrapEl=document.getElementById("wb-wrapper"),this.ctrlEl=this.wrapEl.getElementsByClassName("wb-ctrl-wrap")[0],this.layerSelectWrap=this.ctrlEl.getElementsByClassName("wb-layer-select")[0],this.layerOptsWrap=this.ctrlEl.getElementsByClassName("wb-layer-options")[0],this.selectorEl=this.wrapEl.getElementsByClassName("wb-wheel-selector")[0],window.addEventListener("resize",function(){e.adjustLayout()}),this.ctrlEl.getElementsByClassName("wb-download")[0].onclick=function(t){e.onDownloadClick(t)};for(var l=0;l<t;l++)this.addLayerStack(this.dirtyStacks[l]);this.adjustLayout()}else console.error("Template not loaded, unable to initialize app")},e.prototype.adjustLayout=function(){if(this.container){var e=this.container.offsetWidth;this.wrapEl&&(e<=this.smallestWidth?(s(this.wrapEl,"wb-small")||r(this.wrapEl,"wb-small"),s(this.wrapEl,"wb-smallest")||r(this.wrapEl,"wb-smallest")):e<=this.smallWidth?(s(this.wrapEl,"wb-small")||r(this.wrapEl,"wb-small"),n(this.wrapEl,"wb-smallest")):n(this.wrapEl,["wb-small","wb-smallest"]))}},e.prototype.selectStack=function(e){var t=this.layerStacks[this.selectedStack],l=this.getLayerStack(e);t&&t.layerSelectEl&&a(null,t.layerSelectEl),this.selectedStack=this.stackLookup[e],this.showPreviewStack(l),this.setStackTitle(l.name),l.layerSelectEl?a(l.layerSelectEl):this.createLayerSelector(l,!0),a(this.layerSelectWrap,this.layerOptsWrap)},e.prototype.createLayerSelector=function(e){var t=this,s=e.layers.length,n="",o=null,i=null,c=null,d=null,p=null,h=null,y=document.createElement("ul");r(y,"wb-layer-selector");for(var m=0;m<s;m++)(o=e.layers[m]).readOnly||(n=l(o.name),d=document.createElement("a"),p=document.createElement("li"),i=document.createElement("span"),c=document.createElement("span"),r(p,"wb-ctrl-layer"),r(p,"wb-ctrl-layer-"+n),r(i,"wb-color"),o.currentColor&&(i.style.backgroundColor=o.currentColor),c.innerText=o.name,d.appendChild(i),d.appendChild(c),d.setAttribute("data-layeridx",m),d.onclick=function(l){var s=l.target,r=null;"A"!==s.tagName&&(s=s.parentElement),r=parseInt(s.getAttribute("data-layeridx")),t.createLayerOpts(e,r),a(t.layerOptsWrap,t.layerSelectWrap)},p.appendChild(d),y.appendChild(p));p=document.createElement("li"),(h=document.createElement("button")).innerText="Reset All",h.onclick=function(){t.resetAllLayers()},r(h,"wb-reset-all"),p.appendChild(h),y.appendChild(p),e.layerSelectEl=y,this.layerSelectWrap.appendChild(y)},e.prototype.showPreviewStack=function(e){var t=this.wrapEl.getElementsByClassName("wb-wheel-selected");t.length>0&&(t[0].style.display="none",n(t[0],"wb-wheel-selected")),r(e.containEl,"wb-wheel-selected"),e.containEl.style.display="block",e.containEl.style.opacity=1},e.prototype.createLayerOpts=function(e,t){var s=this,n=e.layers[t],o=(l(n.name),n.options),i=null,c=null,d=null,p=null,h=null,y=null,m=null,u="";if("object"==typeof o&&o.length){this.layerOptsWrap.innerHTML="",i=document.createElement("ul"),c=document.createElement("button"),d=document.createElement("button");for(var f=0,w=o.length;f<w;f++)"string"==typeof o[f].name&&o[f].name.trim()?"string"==typeof o[f].color&&o[f].color.trim()?(u="string"!=typeof o[f].operation||-1===e.lb.getOperations().indexOf(o[f].operation.toLowerCase())?this.dfltColorOp:o[f].operation.trim().toLowerCase(),p=document.createElement("li"),y=document.createElement("span"),m=document.createElement("span"),h=document.createElement("a"),r(y,"wb-color"),y.style.backgroundColor=o[f].color.trim(),h.appendChild(y),m.innerHTML=o[f].name.trim(),h.appendChild(m),h.onclick=function(e){var t=e.target,l="",a="";"A"!==t.tagName&&(t=t.parentElement),l=t.getAttribute("data-color"),a=t.getAttribute("data-operation"),s.setLayerColor(n.name,l,a)},h.setAttribute("data-color",o[f].color.trim()),h.setAttribute("data-operation",u),p.appendChild(h),i.appendChild(p)):console.error("Invalid color provided for layer "+n.name+" option "+o.name):console.error("Invalid name provided for layer "+n.name+" option");this.layerOptsWrap.appendChild(i),c.innerText="Back",c.onclick=function(){a(s.layerSelectWrap,s.layerOptsWrap)},d.innerText="Reset",d.onclick=function(){s.resetLayer(n.name)},this.layerOptsWrap.appendChild(c),this.layerOptsWrap.appendChild(d),a(this.layerOptsWrap,this.layerSelectWrap)}},e.prototype.addLayerStack=function(e){var t=this;e&&"object"==typeof e?this.asyncPromise.done(function(){var s=t.getLayerStack(e.name),n=t.wrapEl.getElementsByClassName("wb-wheel-preview")[0],o=null,i=null,c="";if(e.name&&e.name.trim())if(e.name=e.name.trim(),c=l(e.name.toLowerCase()),e.visible=!!e.visible,e.selected=!!e.selected,"object"==typeof e.layers&&e.layers.length){for(var d=0,p=e.layers.length;d<p;d++)e.layers[d]=t.validateLayer(e.layers[d]),e.layers[d]||e.layers.splice(d,1);s?((o=t.wrapEl.getElementById("wb-wheel-"+c)).innerHTML="",idx=t.stackLookup[e.name],t.layerStacks[idx]=e):((o=document.createElement("div")).id="wb-wheel-"+c,n.appendChild(o),idx=t.layerStacks.length,t.stackLookup[e.name]=idx,t.layerStacks[idx]=e),r(o,"wb-wheel"),(i=new LayerBuilder(o.id,{dimensions:t.wheelDims})).setLayers(e.layers).done(function(){dims=i.getDimensions(),o.style.width=dims.width+"px",o.style.height=dims.height+"px",e.visible&&t.addStackSelector(e),e.selected||a(null,o)}),i.imgLoadPromise.done(function(){t.checkLoaded()}),t.layerStacks[idx].lb=i,t.layerStacks[idx].containEl=o,t.layerStacks[idx].idx=idx,e.visible&&(t.visibleStacks++,e.selected&&(r(o,"wb-wheel-selected"),t.selectedStack=idx,t.selectStack(e.name)))}else console.error("No layers provided");else console.error("No name provided for layer stack")}):console.error("Invalid layer stack")},e.prototype.addStackSelector=function(e){var t=this,l=e.lb.getImage(),a=new Image,s=document.createElement("li");if(a.src=l,s.appendChild(a),s.onclick=function(l){var a=l.target,s=a,o=t.selectorEl.getElementsByClassName("wb-stack-selected")[0];"li"!==a.tagName.toLowerCase&&(s=a.parentElement),n(o,"wb-stack-selected"),t.selectStack(e.name),r(s,"wb-stack-selected")},e.selected&&r(s,"wb-stack-selected"),this.selectorEl.children.length){var o=this.selectorEl.children[e.idx];o?this.selectorEl.insertBefore(s,o):e.idx>=this.selectorEl.children.length?this.selectorEl.appendChild(s):this.selectorEl.insertBefore(s,this.selectorEl.firstChild)}else this.selectorEl.appendChild(s);this.visibleStacks>1?this.selectorEl.style.opacity=1:this.selectorEl.style.opacity=0},e.prototype.setLayerColor=function(e,t,a){var s=this.layerStacks.length,r=null,n=null,o=null,i=l(e),c=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+i);if("string"==typeof e&&e.trim()){for(var d=0;d<s;d++)if(n=this.layerStacks[d],(o=n.lb.getLayer(e))&&!o.readOnly){n.lb.setColor(e,t,a),r=n.layers.length;for(var p=0;p<r;p++)n.layers[p].name===e&&(n.layers[p].currentColor=t)}for(s=c.length,d=0;d<s;d++)c[d].getElementsByTagName("span")[0].style.backgroundColor=t}else console.error("Invalid layer name")},e.prototype.resetLayer=function(e){for(var t=this.layerStacks.length,a=null,s=null,r=l(e),n=this.layerSelectWrap.getElementsByClassName("wb-ctrl-layer-"+r),o=0;o<t;o++){(s=this.layerStacks[o]).lb.resetLayer(e),a=s.layers.length;for(var i=0;i<a;i++)s.layers[i].name===e&&(s.layers[i].currentColor="")}for(t=n.length,o=0;o<t;o++)n[o].getElementsByTagName("span")[0].style.backgroundColor=""},e.prototype.resetAllLayers=function(){for(var e=this.layerStacks.length,t=null,l=null,a=this.ctrlEl.getElementsByClassName("wb-color"),s=0;s<e;s++){(l=this.layerStacks[s]).lb.resetAllLayers(),t=l.layers.length;for(var r=0;r<t;r++)l.layers[r].currentColor=""}for(e=a.length,s=0;s<e;s++)a[s].style.backgroundColor=""},e.prototype.validateLayer=function(e){return"object"!=typeof e?(console.error("Invalid layer for stack "+ls.name),!1):"string"!=typeof e.name||"string"!=typeof e.img?(console.error("Layer name and img properties invalid"),!1):(e.name=e.name.trim(),e.img=e.img.trim(),e.label="string"==typeof e.label&&e.label.trim()?e.label:e.name,e.readOnly=!!e.readOnly,e.options&&"object"==typeof e.options&&e.options.length||(self.defaultLayerOpts.length?e.options=self.defaultLayerOpts:(e.readOnly=!0,e.options=[])),e)},e.prototype.getLayerStack=function(e){return this.stackLookup.hasOwnProperty(e)?this.layerStacks[this.stackLookup[e]]:null},e.prototype.setStackTitle=function(e){"string"==typeof e&&(this.ctrlEl.getElementsByClassName("wb-ctrl-title")[0].innerHTML=e)},e.prototype.loadTemplate=function(e){var t=this,l=new XMLHttpRequest;l.onreadystatechange=function(){4===l.readyState&&(200===l.status?(t.tplHtml=l.responseText,t.tplLoaded=!0,"function"==typeof e&&e.apply(t)):console.error("xhr request for template failed"))},l.open("GET",this.tplUrl,!0),l.send(null)},e.prototype.loadStyles=function(e){if(this.cssUrl){var t=this,l=document.createElement("link"),a=document.getElementsByTagName("head")[0];l.rel="stylesheet",l.type="text/css",l.href=this.cssUrl,l.onload=function(){t.cssLoaded||(t.cssLoaded=!0,"function"==typeof e&&e.apply(t))},a.insertBefore(l,a.firstElementChild)}else this.cssLoaded=!0},e.prototype.getStackImage=function(e){var t=this.getLayerStack(e),l=null;return t&&t.lb&&(l=t.lb.getUnscaledImage()),l},e.prototype.onDownloadClick=function(e){var t=e.target,a=this.layerStacks[this.selectedStack],s=l(a.name)+".png",r="";a&&a.lb?(r=this.getStackImage(a.name),window.navigator.msSaveBlob?window.navigator.msSaveBlob(r,s):(t.href=r,t.download=s)):console.error("Cannot export: no stack selected")};var l=function(e){return e.replace(/\W+/g,"-")},a=function(e,t){t&&(t.style.display="none",t.style.opacity=0),e&&(e.style.display="block",e.style.opacity=1)},s=function(e,t){var l=new RegExp("(?:\\s|^)"+t+"(?:\\s|$)");return!!e.className.match(l)},r=function(e,t){-1===e.className.indexOf(t)&&(e.className+=" "+t,e.className=e.className.trim())},n=function(e,t){var l=null,a=0;"object"!=typeof t&&(t=[t]),a=t.length;for(var s=0;s<a;s++)l=new RegExp("(?:\\s|^)"+t[s]+"(?:\\s|$)"),e.className=e.className.replace(l," ")};window.WheelBuilder=e}();